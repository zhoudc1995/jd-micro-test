!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).microApp={})}(this,(function(e){"use strict";const t="1.0.0-rc.4",n="undefined"!=typeof window,o="undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:Function("return this")(),r=()=>!1,i=Array.isArray,s=Object.assign,a=Object.defineProperty,c=Object.defineProperties,l=Object.prototype.toString,u=Object.prototype.hasOwnProperty,p=e=>l.call(e);function h(e){return void 0===e}function d(e){return null===e}function m(e){return"string"==typeof e}function f(e){return"boolean"==typeof e}function _(e){return"number"==typeof e}function A(e){return"function"==typeof e}function w(e){return"[object Object]"===p(e)}function y(e){return!d(e)&&"object"==typeof e}function g(e){return"[object Promise]"===p(e)}function b(e){var t;if(A(e)){const n=e.toString();return(null===(t=e.prototype)||void 0===t?void 0:t.constructor)===e&&Object.getOwnPropertyNames(e.prototype).length>1||/^function\s+[A-Z]/.test(n)||/^class\s+/.test(n)}return!1}function v(e){var t;return e instanceof URL||!!(null===(t=e)||void 0===t?void 0:t.href)}function E(e){var t;return e instanceof Element||m(null===(t=e)||void 0===t?void 0:t.tagName)}function P(e){var t;return e instanceof Node||_(null===(t=e)||void 0===t?void 0:t.nodeType)}function R(e){return"[object HTMLLinkElement]"===p(e)}function S(e){return"[object HTMLStyleElement]"===p(e)}function M(e){return"[object HTMLScriptElement]"===p(e)}function C(e){return E(e)&&"MICRO-APP-BODY"===e.tagName.toUpperCase()}function N(e,t,n){if(null==e)throw new TypeError("includes target is null or undefined");const o=Object(e),r=parseInt(o.length,10)||0;if(0===r)return!1;n=parseInt(n,10)||0;let i=Math.max(n>=0?n:r+n,0);for(;i<r;){if(t===o[i]||t!=t&&o[i]!=o[i])return!0;i++}return!1}function O(e,t=null,...n){const o=t&&m(t)?` app ${t}:`:"";m(e)?console.error(`[micro-app]${o} ${e}`,...n):console.error(`[micro-app]${o}`,e,...n)}function D(e,t=null,...n){const o=t&&m(t)?` app ${t}:`:"";m(e)?console.warn(`[micro-app]${o} ${e}`,...n):console.warn(`[micro-app]${o}`,e,...n)}function I(e,...t){Promise.resolve().then(e.bind(null,...t))}const x=function(){class e extends URL{}return(t,n)=>n?new e(""+t,n):new e(""+t)}();function L(e){return e.startsWith("//")?`${o.location.protocol}${e}`:e}function T(e,t=null){if(!m(e)||!e)return"";try{const{origin:t,pathname:n,search:o}=x(L(e),(window.rawWindow||window).location.href);if(/\.(\w+)$/.test(n))return`${t}${n}${o}`;const r=`${t}${n}/`.replace(/\/\/$/,"/");return/^https?:\/\//.test(r)?`${r}${o}`:""}catch(e){return O(e,t),""}}function W(e){return m(e)&&e?e.replace(/(^\d+)|([^\w\d-_])/gi,""):""}function U(e){const{origin:t,pathname:n}=x(e);if(/\.(\w+)$/.test(n)){const e=`${t}${n}`.split("/");return e.pop(),e.join("/")+"/"}return`${t}${n}/`.replace(/\/\/$/,"/")}function B(e,t){return!e||/^((((ht|f)tps?)|file):)?\/\//.test(e)||/^(data|blob):/.test(e)?e:x(e,U(L(t))).toString()}function k(e,t,n,o){let r=0;function i(){++r===e.length&&o&&o()}e.forEach(((e,o)=>{g(e)?e.then((e=>{t({data:e,index:o}),i()})).catch((e=>{n({error:e,index:o}),i()})):(t({data:e,index:o}),i())}))}const H=o.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1)};function F(e){return new Promise((t=>{H((()=>{e(t)}))}))}let $=null;function j(e){$=e}function K(){return $}let q=!1;function G(e){j(null),e&&!q&&(q=!0,I((()=>{q=!1})))}function Q(e){$===e||q||(j(e),I((()=>{j(null)})))}function X(e,t){const n=(window.rawDocument||document).createElement(e,t);return n.__MICRO_APP_NAME__&&delete n.__MICRO_APP_NAME__,n.__PURE_ELEMENT__=!0,n}function z(e){return!e||/(^\d)|([^\w\d-_\u4e00-\u9fa5])/gi.test(e)}function V(e){return/^body$/i.test(e)||/^head$/i.test(e)||/^html$/i.test(e)||/^title$/i.test(e)||/^:root$/i.test(e)}function Y(e){return function(e){return"undefined"!=typeof ShadowRoot&&e instanceof ShadowRoot}(e)?e.host:e}function J(e){return e?e.replace(/^\s+|\s+$/g,""):""}function Z(){return navigator.userAgent.indexOf("Firefox")>-1}function ee(e){const t={},n=e.split("&");for(const e of n){const n=e.indexOf("="),o=n<0?e:e.slice(0,n),r=n<0?null:e.slice(n+1);if(o in t){let e=t[o];i(e)||(e=t[o]=[e]),e.push(r)}else t[o]=r}return t}function te(e){let t="";for(const n in e){const o=e[n];if(d(o))t+=(t.length?"&":"")+n;else{(i(o)?o:[o]).forEach((e=>{h(e)||(t+=(t.length?"&":"")+n,d(e)||(t+="="+e))}))}}return t}function ne(){const e=new Set;return{add:function(t){return e.add(t),()=>!!e.has(t)&&e.delete(t)},list:()=>e}}function oe(e){const t=e.attributes,n=new Map;for(let e=0;e<t.length;e++)n.set(t[e].name,t[e].value);return n}function re(e,t){e?e.push((()=>F((e=>{t(),e()})))):t()}function ie(e){return(null==e?void 0:e.reduce(((e,t)=>e.then(t)),Promise.resolve()))||null}function se(e){return e.startsWith("inline-")}function ae(e,t,n,...o){try{A(e)&&e(...o)}catch(e){O(`An error occurred in app ${t} window.${n} \n`,null,e)}}function ce(e,t,n,o){var r;if(!e)return O(`element does not exist in lifecycle ${n}`,t);e=Y(e),G();const i=s({name:t,container:e},o&&{error:o}),a=new CustomEvent(n,{detail:i});!function(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},target:{get:()=>t}})}(a,e),A(null===(r=io.options.lifeCycles)||void 0===r?void 0:r[n])&&io.options.lifeCycles[n](a),e.dispatchEvent(a)}function le(e,t,n={}){var o;const r=new CustomEvent(t,{detail:n});null===(o=e.sandBox)||void 0===o||o.microAppWindow.dispatchEvent(r)}function ue(e,t=null,n={}){return G(),A(io.options.fetch)?io.options.fetch(e,n,t):window.fetch(e,n).then((e=>e.text()))}class pe{static getInstance(){return this.instance||(this.instance=new pe),this.instance}run(e,t){const n=e.name,o=e.ssrUrl||e.url;(o.includes(".js")?Promise.resolve(`<micro-app-head><script src='${o}'><\/script></micro-app-head><micro-app-body></micro-app-body>`):ue(o,n,{cache:"no-cache"})).then((r=>{if(!r){const t="html is empty, please check in detail";return e.onerror(new Error(t)),O(t,n)}r=this.formatHTML(o,r,n),t(r,e)})).catch((t=>{O(`Failed to fetch data from ${e.url}, micro-app stop rendering`,n,t),e.onLoadError(t)}))}formatHTML(e,t,n){return this.processHtml(e,t,n,io.options.plugins).replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<micro-app-head").replace(/<\/head>/i,"</micro-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<micro-app-body").replace(/<\/body>/i,"</micro-app-body>")))}processHtml(e,t,n,o){var r;if(!o)return t;const i=[];return o.global&&i.push(...o.global),(null===(r=o.modules)||void 0===r?void 0:r[n])&&i.push(...o.modules[n]),i.length>0?i.reduce(((t,n)=>w(n)&&A(n.processHtml)?n.processHtml(t,e):t),t):t}}const he=/(^|\s+)(html|:root)(?=[\s>~[.#:]+|$)/,de=/(^|\s+)((html[\s>~]+body)|body)(?=[\s>~[.#:]+|$)/;function me(e,t){e=t?`${t} ${e}`:e;const n=new Error(e);throw n.reason=e,t&&(n.filename=t),n}class fe{constructor(){this.cssText="",this.prefix="",this.baseURI="",this.linkPath="",this.result="",this.scopecssDisable=!1,this.scopecssDisableSelectors=[],this.scopecssDisableNextLine=!1,this.mediaRule=this.createMatcherForRuleWithChildRule(/^@media *([^{]+)/,"@media"),this.supportsRule=this.createMatcherForRuleWithChildRule(/^@supports *([^{]+)/,"@supports"),this.documentRule=this.createMatcherForRuleWithChildRule(/^@([-\w]+)?document *([^{]+)/,"@document"),this.hostRule=this.createMatcherForRuleWithChildRule(/^@host\s*/,"@host"),this.importRule=this.createMatcherForNoneBraceAtRule("import"),this.charsetRule=this.createMatcherForNoneBraceAtRule("charset"),this.namespaceRule=this.createMatcherForNoneBraceAtRule("namespace"),this.containerRule=this.createMatcherForRuleWithChildRule(/^@container *([^{]+)/,"@container")}exec(e,t,n,o){return this.cssText=e,this.prefix=t,this.baseURI=n,this.linkPath=o||"",this.matchRules(),Z()?decodeURIComponent(this.result):this.result}reset(){this.cssText=this.prefix=this.baseURI=this.linkPath=this.result="",this.scopecssDisable=this.scopecssDisableNextLine=!1,this.scopecssDisableSelectors=[]}matchRules(){for(this.matchLeadingSpaces(),this.matchComments();this.cssText.length&&"}"!==this.cssText.charAt(0)&&(this.matchAtRule()||this.matchStyleRule());)this.matchComments()}matchStyleRule(){const e=this.formatSelector(!0);return this.scopecssDisableNextLine=!1,e?(this.recordResult(e),this.matchComments(),this.styleDeclarations(),this.matchLeadingSpaces(),!0):me("selector missing",this.linkPath)}formatSelector(e){const t=this.commonMatch(/^[^{]+/,e);return!!t&&t[0].replace(/(^|,[\n\s]*)([^,]+)/g,((e,t,n)=>(n=J(n),this.scopecssDisableNextLine||this.scopecssDisable&&(!this.scopecssDisableSelectors.length||this.scopecssDisableSelectors.includes(n))||he.test(n)||(n=de.test(n)?n.replace(de,this.prefix+" micro-app-body"):this.prefix+" "+n),t+n)))}styleDeclarations(){return this.matchOpenBrace()?(this.matchAllDeclarations(),!!this.matchCloseBrace()||me("Declaration missing '}'",this.linkPath)):me("Declaration missing '{'",this.linkPath)}matchAllDeclarations(e=1){let t=this.commonMatch(/^(?:url\(["']?(?:[^)"'}]+)["']?\)|[^{}/])*/,!0)[0];if(t&&(this.scopecssDisableNextLine||this.scopecssDisable&&!this.scopecssDisableSelectors.length||(t=t.replace(/url\(["']?([^)"']+)["']?\)/gm,((e,t)=>/^((data|blob):|#)/.test(t)||/^(https?:)?\/\//.test(t)?e:(/^((\.\.?\/)|[^/])/.test(t)&&this.linkPath&&(this.baseURI=function(e){const t=e.split("/");return t.pop(),L(t.join("/")+"/")}(this.linkPath)),`url("${B(t,this.baseURI)}")`)))),this.recordResult(t)),this.scopecssDisableNextLine=!1,this.cssText){if("}"===this.cssText.charAt(0)){if(!e)return;return e>1&&this.commonMatch(/}+/),this.matchAllDeclarations(e-1)}return"/"===this.cssText.charAt(0)&&("*"===this.cssText.charAt(1)?this.matchComments():this.commonMatch(/\/+/)),"{"===this.cssText.charAt(0)&&(this.commonMatch(/{+\s*/),e++),this.matchAllDeclarations(e)}}matchAtRule(){return"@"===this.cssText[0]&&(this.scopecssDisableNextLine=!1,this.keyframesRule()||this.mediaRule()||this.customMediaRule()||this.supportsRule()||this.importRule()||this.charsetRule()||this.namespaceRule()||this.containerRule()||this.documentRule()||this.pageRule()||this.hostRule()||this.fontFaceRule())}keyframesRule(){if(!this.commonMatch(/^@([-\w]+)?keyframes\s*/))return!1;if(!this.commonMatch(/^[^{]+/))return me("@keyframes missing name",this.linkPath);if(this.matchComments(),!this.matchOpenBrace())return me("@keyframes missing '{'",this.linkPath);for(this.matchComments();this.keyframeRule();)this.matchComments();return this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):me("@keyframes missing '}'",this.linkPath)}keyframeRule(){let e;const t=[];for(;e=this.commonMatch(/^((\d+\.\d+|\.\d+|\d+)%?|[a-z]+)\s*/);)t.push(e[1]),this.commonMatch(/^,\s*/);return!!t.length&&(this.styleDeclarations(),this.matchLeadingSpaces(),!0)}customMediaRule(){return!!this.commonMatch(/^@custom-media\s+(--[^\s]+)\s*([^{;]+);/)&&(this.matchLeadingSpaces(),!0)}pageRule(){return!!this.commonMatch(/^@page */)&&(this.formatSelector(!1),this.scopecssDisableNextLine=!1,this.commonHandlerForAtRuleWithSelfRule("page"))}fontFaceRule(){return!!this.commonMatch(/^@font-face\s*/)&&this.commonHandlerForAtRuleWithSelfRule("font-face")}createMatcherForRuleWithChildRule(e,t){return()=>!!this.commonMatch(e)&&(this.matchOpenBrace()?(this.matchComments(),this.matchRules(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):me(`${t} missing '}'`,this.linkPath)):me(`${t} missing '{'`,this.linkPath))}createMatcherForNoneBraceAtRule(e){const t=new RegExp("^@"+e+"\\s*([^;]+);");return()=>!!this.commonMatch(t)&&(this.matchLeadingSpaces(),!0)}commonHandlerForAtRuleWithSelfRule(e){return this.matchOpenBrace()?(this.matchAllDeclarations(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):me(`@${e} missing '}'`,this.linkPath)):me(`@${e} missing '{'`,this.linkPath)}matchComments(){for(;this.matchComment(););}matchComment(){if("/"!==this.cssText.charAt(0)||"*"!==this.cssText.charAt(1))return!1;this.scopecssDisableNextLine=!1;let e=2;for(;""!==this.cssText.charAt(e)&&("*"!==this.cssText.charAt(e)||"/"!==this.cssText.charAt(e+1));)++e;if(e+=2,""===this.cssText.charAt(e-1))return me("End of comment missing",this.linkPath);let t=this.cssText.slice(2,e-2);if(this.recordResult(`/*${t}*/`),t=J(t.replace(/^\s*!/,"")),"scopecss-disable-next-line"===t)this.scopecssDisableNextLine=!0;else if(/^scopecss-disable/.test(t))if("scopecss-disable"===t)this.scopecssDisable=!0;else{this.scopecssDisable=!0;t.replace("scopecss-disable","").split(",").forEach((e=>{this.scopecssDisableSelectors.push(J(e))}))}else"scopecss-enable"===t&&(this.scopecssDisable=!1,this.scopecssDisableSelectors=[]);return this.cssText=this.cssText.slice(e),this.matchLeadingSpaces(),!0}commonMatch(e,t=!1){const n=e.exec(this.cssText);if(!n)return;const o=n[0];return this.cssText=this.cssText.slice(o.length),t||this.recordResult(o),n}matchOpenBrace(){return this.commonMatch(/^{\s*/)}matchCloseBrace(){return this.commonMatch(/^}/)}matchLeadingSpaces(){this.commonMatch(/^\s*/)}recordResult(e){Z()?this.result+=encodeURIComponent(e):this.result+=e}}function _e(e,t,n,o,r){if(!e.__MICRO_APP_HAS_SCOPED__){e.__MICRO_APP_HAS_SCOPED__=!0;let i=null;try{i=Ae.exec(e.textContent,n,o,r),Ae.reset()}catch(e){Ae.reset(),O("An error occurred while parsing CSS:\n",t,e)}i&&(e.textContent=i)}}let Ae;function we(e,t,n){if(t.scopecss){const o=ye(t.name);if(Ae||(Ae=new fe),e.textContent)_e(e,t.name,o,t.url,n);else{const r=new MutationObserver((function(){r.disconnect(),e.textContent&&!e.hasAttribute("data-styled")&&_e(e,t.name,o,t.url,n)}));r.observe(e,{childList:!0})}}return e}function ye(e,t=!1){const n=t?"\\":"";return`${io.tagName}${n}[name=${e}${n}]`}function ge(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},srcElement:{get:()=>t},target:{get:()=>t}})}function be(e){const t=new CustomEvent("load");ge(t,e),A(e.onload)?e.onload(t):e.dispatchEvent(t)}function ve(e){const t=new CustomEvent("error");ge(t,e),A(e.onerror)?e.onerror(t):e.dispatchEvent(t)}var Ee,Pe,Re,Se,Me,Ce,Ne=function(){const e=new Map,t=new Map;function n(e){return{setInfo(t,n){e.set(t,n)},getInfo(t){var n;return null!==(n=e.get(t))&&void 0!==n?n:null},hasInfo:t=>e.has(t),deleteInfo:t=>e.delete(t)}}return{link:n(e),script:Object.assign(Object.assign({},n(t)),{deleteInlineInfo(e){e.forEach((e=>{se(e)&&t.delete(e)}))}})}}();function Oe(e,t,n,o=!1){const r=e.getAttribute("rel");let i=e.getAttribute("href"),s=null;if("stylesheet"===r&&i){i=B(i,n.url);let t=Ne.link.getInfo(i);const r={attrs:oe(e)};if(t?t.appSpace[n.name]=t.appSpace[n.name]||r:t={code:"",appSpace:{[n.name]:r}},Ne.link.setInfo(i,t),o)return{address:i,linkInfo:t};n.source.links.add(i),s=document.createComment(`link element with href=${i} move to micro-app-head as style element`),t.appSpace[n.name].placeholder=s}else r&&["prefetch","preload","prerender"].includes(r)?o?s=document.createComment(`link element with rel=${r}${i?" & href="+i:""} removed by micro-app`):null==t||t.removeChild(e):i&&Gn.rawSetAttribute.call(e,"href",B(i,n.url));return o?{replaceComment:s}:s?null==t?void 0:t.replaceChild(s,e):void 0}function De(e,t,n,o){const r=Array.from(t.source.links),i=r.map((e=>{const n=Ne.link.getInfo(e);return n.code?n.code:ue(e,t.name)})),s=o?[]:null;k(i,(e=>{re(s,(()=>function(e,t,n,o){const r=Ne.link.getInfo(e);r.code=t;const i=r.appSpace[o.name],s=i.placeholder;if(s){const t=X("style");Ie(o,e,t,r,i.attrs),s.parentNode?s.parentNode.replaceChild(t,s):n.appendChild(t),i.placeholder=null}}(r[e.index],e.data,n,t)))}),(e=>{O(e,t.name)}),(()=>{o?o.then((()=>{s.push((()=>Promise.resolve(t.onLoad({html:e})))),ie(s)})):t.onLoad({html:e})}))}function Ie(e,t,n,o,r){if(e.scopecss){const r=o.appSpace[e.name];if(r.prefix=r.prefix||ye(e.name),r.parsedCode)n.textContent=r.parsedCode;else{const i=function(e,t,n){const o=n.appSpace;for(const n in o)if(n!==e){const e=o[n];if(e.parsedCode)return e.parsedCode.replace(new RegExp(ye(n,!0),"g"),t)}}(e.name,r.prefix,o);i?n.textContent=i:(n.textContent=o.code,we(n,e,t)),r.parsedCode=n.textContent}}else n.textContent=o.code;!function(e,t){t.forEach(((t,n)=>{"rel"!==n&&("href"===n&&(n="data-origin-href"),Gn.rawSetAttribute.call(e,n,t))}))}(n,r)}!function(e){e.NAME="name",e.URL="url"}(Ee||(Ee={})),function(e){e.CREATED="created",e.LOADING="loading",e.LOAD_FAILED="load_failed",e.BEFORE_MOUNT="before_mount",e.MOUNTING="mounting",e.MOUNTED="mounted",e.UNMOUNT="unmount"}(Pe||(Pe={})),function(e){e.CREATED="created",e.BEFOREMOUNT="beforemount",e.MOUNTED="mounted",e.UNMOUNT="unmount",e.ERROR="error",e.BEFORESHOW="beforeshow",e.AFTERSHOW="aftershow",e.AFTERHIDDEN="afterhidden"}(Re||(Re={})),function(e){e.ONMOUNT="onmount",e.ONUNMOUNT="onunmount"}(Se||(Se={})),function(e){e.KEEP_ALIVE_SHOW="keep_alive_show",e.KEEP_ALIVE_HIDDEN="keep_alive_hidden"}(Me||(Me={})),function(e){e.DESTROY="destroy",e.DESTORY="destory",e.INLINE="inline",e.DISABLESCOPECSS="disableScopecss",e.DISABLESANDBOX="disableSandbox",e.DISABLE_SCOPECSS="disable-scopecss",e.DISABLE_SANDBOX="disable-sandbox",e.DISABLE_MEMORY_ROUTER="disable-memory-router",e.DISABLE_PATCH_REQUEST="disable-patch-request",e.KEEP_ROUTER_STATE="keep-router-state",e.HIDDEN_ROUTER="hidden-router",e.KEEP_ALIVE="keep-alive",e.CLEAR_DATA="clear-data",e.SSR="ssr",e.FIBER="fiber"}(Ce||(Ce={}));const xe=[1,2,3],Le="search",Te="native",We="native-scope",Ue="pure",Be=[Le,Te,We,Ue],ke=["popstate","hashchange","load","beforeunload","unload","unmount","appstate-change","statechange","mounted"],He=["onpopstate","onhashchange","onload","onbeforeunload","onunload","onerror"],Fe=["DOMContentLoaded","readystatechange"],$e=["onreadystatechange"],je=["window","self","globalThis"],Ke=["rawWindow","rawDocument"],qe="window,self,globalThis,document,Document,Array,Object,String,Boolean,Math,Number,Symbol,Date,Function,Proxy,WeakMap,WeakSet,Set,Map,Reflect,Element,Node,RegExp,Error,TypeError,JSON,isNaN,parseFloat,parseInt,performance,console,decodeURI,encodeURI,decodeURIComponent,encodeURIComponent,navigator,undefined,location,history",Ge=["text/javascript","text/ecmascript","application/javascript","application/ecmascript","module","systemjs-module","systemjs-importmap"];function Qe(e,t){return t.appSpace[e.name].module&&(!e.useSandbox||e.iframe)}function Xe(e,t){return e.inline||t.appSpace[e.name].inline||Qe(e,t)||function(e,t){return t.appSpace[e.name].attrs.has("id")}(e,t)}function ze(e){return e.iframe?e.sandBox.microAppWindow:Gn.rawWindow}function Ve(e,t,n){return function(e,t,n){const o=t.appSpace;for(const t in o)if(t!==e.name){const e=o[t];if(e.parsedCode===n&&e.parsedFunction)return e.parsedFunction}}(e,t,n)||function(e,t){return new(ze(e).Function)(t)}(e,n)}function Ye(){const e="inline-"+Math.random().toString(36).substr(2,15);return Ne.script.hasInfo(e)?Ye():e}function Je(e,t){return e.useSandbox&&!Qe(e,t)}function Ze(e,t){return Je(e,t)?e.iframe?"iframe":"with":"disable"}function et(e,t,n,o=!1){var r;let i=null,s=e.getAttribute("src");if(s&&(s=B(s,n.url)),e.hasAttribute("exclude")||nt(s,n.name))i=document.createComment("script element with exclude attribute removed by micro-app");else{if(e.type&&!Ge.includes(e.type)||e.hasAttribute("ignore")||ot(s,n.name))return(null===(r=Gn.rawDocument)||void 0===r?void 0:r.currentScript)&&delete Gn.rawDocument.currentScript,null;if(Gn.supportModuleScript&&e.noModule||!Gn.supportModuleScript&&"module"===e.type)i=document.createComment((e.noModule?"noModule":"module")+" script ignored by micro-app");else if(s){let t=Ne.script.getInfo(s);const r={async:e.hasAttribute("async"),defer:e.defer||"module"===e.type,module:"module"===e.type,inline:e.hasAttribute("inline"),pure:e.hasAttribute("pure"),attrs:oe(e)};if(t?t.appSpace[n.name]=t.appSpace[n.name]||r:t={code:"",isExternal:!0,appSpace:{[n.name]:r}},Ne.script.setInfo(s,t),o)return{address:s,scriptInfo:t};n.source.scripts.add(s),i=document.createComment(`script with src='${s}' extract by micro-app`)}else if(e.textContent){const t=Ye(),r={code:e.textContent,isExternal:!1,appSpace:{[n.name]:{async:!1,defer:"module"===e.type,module:"module"===e.type,inline:e.hasAttribute("inline"),pure:e.hasAttribute("pure"),attrs:oe(e)}}};if(o)return{address:t,scriptInfo:r};n.source.scripts.add(t),Ne.script.setInfo(t,r),i=document.createComment("inline script extract by micro-app")}else o||(i=document.createComment("script element removed by micro-app"))}return o?{replaceComment:i}:null==t?void 0:t.replaceChild(i,e)}function tt(e){var t,n,o;return[...(null===(t=io.options.plugins)||void 0===t?void 0:t.global)||[],...(null===(o=null===(n=io.options.plugins)||void 0===n?void 0:n.modules)||void 0===o?void 0:o[e])||[]]}function nt(e,t){if(!e)return!1;return(tt(t)||[]).some((t=>!!t.excludeChecker&&t.excludeChecker(e)))}function ot(e,t){if(!e)return!1;return(tt(t)||[]).some((t=>!!t.ignoreChecker&&t.ignoreChecker(e)))}function rt(e,t){const n=Array.from(t.source.scripts),o=[],r=[];for(const e of n){const n=Ne.script.getInfo(e),i=n.appSpace[t.name];(!i.defer&&!i.async||t.isPrefetch&&!t.isPrerender)&&(o.push(n.code?n.code:ue(e,t.name)),r.push([e,n]))}const i=t.isPrefetch||t.fiber?[]:null;o.length?k(o,(e=>{re(i,(()=>function(e,t,n,o){if(t.code=n,o.isPrefetch&&2===o.prefetchLevel){const r=t.appSpace[o.name];if(!r.parsedCode&&(r.parsedCode=st(e,o,n,t),r.sandboxType=Ze(o,t),!Xe(o,t)))try{r.parsedFunction=Ve(o,t,r.parsedCode)}catch(e){O("Something went wrong while handling preloaded resources",o.name,"\n",e)}}}(r[e.index][0],r[e.index][1],e.data,t)))}),(e=>{O(e,t.name)}),(()=>{i?(i.push((()=>Promise.resolve(t.onLoad({html:e})))),ie(i)):t.onLoad({html:e})})):t.onLoad({html:e})}function it(e,t,n,o,r){try{!function(e){!function(e){e.sandBox&&(Gn.rawWindow.__MICRO_APP_PROXY_WINDOW__=e.sandBox.proxyWindow)}(e)}(t);const i=n.appSpace[t.name],s=Ze(t,n);if(i.parsedCode&&i.sandboxType===s||(i.parsedCode=st(e,t,n.code,n),i.sandboxType=s,i.parsedFunction=null),Xe(t,n)){const s=r||X("script");if(function(e,t,n,o,r,i){if(n){if(Gn.rawSetAttribute.call(o,"type","module"),se(e)?o.textContent=t:o.src=e,i){const t=()=>{i.moduleCount&&i.moduleCount--,i(0===i.moduleCount)};se(e)?I(t):o.onload=t}}else o.textContent=t;!function(e,t){t.forEach(((t,n)=>{"type"===n&&"module"===t||"defer"===n||"async"===n||("src"===n&&(n="data-origin-src"),Gn.rawSetAttribute.call(e,n,t))}))}(o,r)}(e,i.parsedCode,Qe(t,n),s,i.attrs,o),!r){const e=t.iframe?t.sandBox.microBody:t.querySelector("micro-app-body");null==e||e.appendChild(s)}}else!function(e,t){const n=t.appSpace[e.name];n.parsedFunction||(n.parsedFunction=Ve(e,t,n.parsedCode));n.parsedFunction.call(ze(e))}(t,n)}catch(n){throw console.error(`[micro-app from ${r?"runDynamicScript":"runScript"}] app ${t.name}: `,n,e),n}}function st(e,t,n,o){return w(io.options.plugins)&&(n=function(e,t,n,o){var r;const i=at(o.global,t,e);return at(null===(r=o.modules)||void 0===r?void 0:r[n],i,e)}(e,n,t.name,io.options.plugins)),Je(t,o)?t.iframe?`(function(window,self,global,location){;${n}\n${se(e)?"":`//# sourceURL=${e}\n`}}).call(window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyLocation);`:`;(function(proxyWindow){with(proxyWindow.__MICRO_APP_WINDOW__){(function(${qe}){;${n}\n${se(e)?"":`//# sourceURL=${e}\n`}}).call(proxyWindow,${qe})}})(window.__MICRO_APP_PROXY_WINDOW__);`:n}function at(e,t,n){return i(e)?e.reduce(((e,t)=>w(t)&&A(t.loader)?t.loader(e,n):e),t):t}function ct(e,t,n,o){const r=Array.from(e.children);r.length&&r.forEach((e=>{ct(e,t,n,o)}));for(const n of r)R(n)?n.hasAttribute("exclude")||nt(n.getAttribute("href"),t.name)?e.replaceChild(document.createComment("link element with exclude attribute ignored by micro-app"),n):n.hasAttribute("ignore")||ot(n.getAttribute("href"),t.name)?n.hasAttribute("href")&&Gn.rawSetAttribute.call(n,"href",B(n.getAttribute("href"),t.url)):Oe(n,e,t):S(n)?n.hasAttribute("exclude")?e.replaceChild(document.createComment("style element with exclude attribute ignored by micro-app"),n):t.scopecss&&!n.hasAttribute("ignore")&&re(o,(()=>we(n,t))):M(n)?et(n,e,t):"[object HTMLImageElement]"===p(n)&&n.hasAttribute("src")&&Gn.rawSetAttribute.call(n,"src",B(n.getAttribute("src"),t.url))}function lt(e,t){const n=t.parseHtmlString(e),o=Gn.rawElementQuerySelector.call(n,"micro-app-head"),r=Gn.rawElementQuerySelector.call(n,"micro-app-body");if(!o||!r){const e=`element ${o?"body":"head"} is missing`;return t.onerror(new Error(e)),O(e,t.name)}const i=t.isPrefetch||t.fiber?[]:null;ct(n,t,o,i);const s=ie(i);t.source.links.size?De(n,t,o,s):s?s.then((()=>t.onLoad({html:n}))):t.onLoad({html:n}),t.source.scripts.size?rt(n,t):t.onLoad({html:n})}const ut=new class{constructor(){this.eventList=new Map,this.queue=[],this.recordStep={},this.process=()=>{var e,t;let n;const o=this.recordStep,r=this.queue;for(this.recordStep={},this.queue=[];n=r.shift();){const r=this.eventList.get(n),i=r.tempData,s=r.force;let a;if(r.tempData=null,r.force=!1,s||!this.isEqual(r.data,i)){r.data=i||r.data;for(const e of r.callbacks){const t=e(r.data);t&&(null!=a?a:a=[]).push(t)}null===(t=(e=o[n]).dispatchDataEvent)||void 0===t||t.call(e),o[n].nextStepList.forEach((e=>e(a)))}}}}isLegalName(e){return!!e||(O("event-center: Invalid name"),!1)}enqueue(e,t,n){this.recordStep[e]?(this.recordStep[e].nextStepList.push(t),n&&(this.recordStep[e].dispatchDataEvent=n)):this.recordStep[e]={nextStepList:[t],dispatchDataEvent:n},!this.queue.includes(e)&&1===this.queue.push(e)&&I(this.process)}isEqual(e,t){if(!t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&e[n]!==t[n])return!1;return!0}on(e,t,n=!1){if(this.isLegalName(e)){if(!A(t))return O("event-center: Invalid callback function");let o=this.eventList.get(e);o?n&&Object.keys(o.data).length&&(!this.queue.includes(e)||this.isEqual(o.data,o.tempData))&&t(o.data):(o={data:{},callbacks:new Set},this.eventList.set(e,o)),o.callbacks.add(t)}}off(e,t){if(this.isLegalName(e)){const n=this.eventList.get(e);n&&(A(t)?n.callbacks.delete(t):n.callbacks.clear())}}clearData(e){if(this.isLegalName(e)){const t=this.eventList.get(e);t&&(t.data={})}}dispatch(e,t,n,o,r){if(this.isLegalName(e)){if(!w(t))return O("event-center: data must be object");let i=this.eventList.get(e);i?(i.tempData=s({},i.tempData||i.data,t),!i.force&&(i.force=!!o)):(i={data:t,callbacks:new Set},this.eventList.set(e,i),i.force=!0),this.enqueue(e,n,r)}}getData(e){var t;const n=this.eventList.get(e);return null!==(t=null==n?void 0:n.data)&&void 0!==t?t:null}};function pt(e,t){return m(e)&&e?t?`__from_base_app_${e}__`:`__from_micro_app_${e}__`:""}class ht{addGlobalDataListener(e,t){const n=this.appName;n&&(e.__APP_NAME__=n,e.__AUTO_TRIGGER__=t),ut.on("global",e,t)}removeGlobalDataListener(e){A(e)&&ut.off("global",e)}setGlobalData(e,t,n){G(),ut.dispatch("global",e,(e=>A(t)&&t(e)),n)}forceSetGlobalData(e,t){this.setGlobalData(e,t,!0)}getGlobalData(){return ut.getData("global")}clearGlobalData(){ut.clearData("global")}clearGlobalDataListener(){const e=this.appName,t=ut.eventList.get("global");if(t)for(const n of t.callbacks)(e&&e===n.__APP_NAME__||!e&&!n.__APP_NAME__)&&t.callbacks.delete(n)}}class dt extends ht{addDataListener(e,t,n){ut.on(pt(W(e),!1),t,n)}removeDataListener(e,t){A(t)&&ut.off(pt(W(e),!1),t)}getData(e,t=!1){return ut.getData(pt(W(e),t))}setData(e,t,n,o){ut.dispatch(pt(W(e),!0),t,(e=>A(n)&&n(e)),o)}forceSetData(e,t,n){this.setData(e,t,n,!0)}clearData(e,t=!0){ut.clearData(pt(W(e),t))}clearDataListener(e){ut.off(pt(W(e),!1))}}class mt extends ht{constructor(e){super(),this.appName=W(e),!this.appName&&O(`Invalid appName ${e}`)}addDataListener(e,t){e.__AUTO_TRIGGER__=t,ut.on(pt(this.appName,!0),e,t)}removeDataListener(e){A(e)&&ut.off(pt(this.appName,!0),e)}getData(e=!0){return ut.getData(pt(this.appName,e))}dispatch(e,t,n){G(),ut.dispatch(pt(this.appName,!1),e,(e=>A(t)&&t(e)),n,(()=>{const t=In.get(this.appName);if((null==t?void 0:t.container)&&w(e)){const e=new CustomEvent("datachange",{detail:{data:ut.getData(pt(this.appName,!1))}});Y(t.container).dispatchEvent(e)}}))}forceDispatch(e,t){this.dispatch(e,t,!0)}clearData(e=!1){ut.clearData(pt(this.appName,e))}clearDataListener(){ut.off(pt(this.appName,!0))}}function ft(e){var t,n;if(e){e.umdDataListeners={global:new Set(null===(t=e.umdDataListeners)||void 0===t?void 0:t.global),normal:new Set(null===(n=e.umdDataListeners)||void 0===n?void 0:n.normal)};const o=ut.eventList.get("global");if(o)for(const t of o.callbacks)e.appName===t.__APP_NAME__&&e.umdDataListeners.global.add(t);const r=ut.eventList.get(pt(e.appName,!0));if(r)for(const t of r.callbacks)e.umdDataListeners.normal.add(t)}}function _t(e){if(null==e?void 0:e.umdDataListeners){for(const t of e.umdDataListeners.global)e.addGlobalDataListener(t,t.__AUTO_TRIGGER__);for(const t of e.umdDataListeners.normal)e.addDataListener(t,t.__AUTO_TRIGGER__);At(e)}}function At(e){null==e||delete e.umdDataListeners}class wt{constructor(){this.appInstanceMap=In}static getInstance(){return this.instance||(this.instance=new wt),this.instance}get(e){return this.appInstanceMap.get(e)}set(e,t){this.appInstanceMap.set(e,t)}getAll(){return Array.from(this.appInstanceMap.values())}clear(){this.appInstanceMap.clear()}}function yt(){gt(),wt.getInstance().getAll().forEach((e=>{e.container&&Y(e.container).disconnectedCallback()})),!window.__MICRO_APP_UMD_MODE__&&wt.getInstance().clear()}function gt(){window.__MICRO_APP_ENVIRONMENT__&&window.removeEventListener("unmount",yt,!1)}function bt(e){return f(e.__MICRO_APP_IS_BOUND_FUNCTION__)?e.__MICRO_APP_IS_BOUND_FUNCTION__:e.__MICRO_APP_IS_BOUND_FUNCTION__=A(t=e)&&0===t.name.indexOf("bound ")&&!t.hasOwnProperty("prototype");var t}function vt(e,t,n="WINDOW"){if(A(e)&&!function(e){return f(e.__MICRO_APP_IS_CONSTRUCTOR__)?e.__MICRO_APP_IS_CONSTRUCTOR__:e.__MICRO_APP_IS_CONSTRUCTOR__=b(e)}(e)&&!bt(e)){const o=`__MICRO_APP_BOUND_${n}_FUNCTION__`;if(e[o])return e[o];const r=e.bind(t);for(const t in e)r[t]=e[t];return e.hasOwnProperty("prototype")&&a(r,"prototype",{value:e.prototype,configurable:!0,enumerable:!1,writable:!0}),e[o]=r}return e}function Et(e,t,n){const{proxyDocument:o,documentEffect:r}=function(e,t){const n=new Map,o=new Map;let r=null,i=null;const{rawDocument:s,rawCreateElement:a,rawCreateElementNS:c,rawAddEventListener:l,rawRemoveEventListener:u}=Gn;function p(t,n){const o=a.call(s,t,n);return o.__MICRO_APP_NAME__=e,o}function h(t,n,o){const r=c.call(s,t,n,o);return r.__MICRO_APP_NAME__=e,r}function d(e,t,o){const r=n.get(e);r?r.add(t):n.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=o),l.call(s,e,t,o)}function m(e,t,o){const r=n.get(e);(null==r?void 0:r.size)&&r.has(t)&&r.delete(t),u.call(s,e,t,o)}const f=()=>{o.clear(),i=null},_=()=>{i=r||i,n.forEach(((e,t)=>{if(e.size){const n=o.get(t)||[];o.set(t,new Set([...n,...e]))}}))},w=()=>{i&&!r&&(b.onclick=i),o.forEach(((e,t)=>{for(const n of e)b.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),f()},y=()=>{A(r)&&u.call(s,"click",r),r=null,n.size&&(n.forEach(((e,t)=>{for(const n of e)u.call(s,t,n)})),n.clear())},g=(()=>{var e;const t=new Map([["onclick",e=>{A(r)&&u.call(s,"click",r,!1),A(e)&&l.call(s,"click",e,!1),r=e}]]),n=(null===(e=io.options)||void 0===e?void 0:e.customProxyDocumentProps)||new Map;return new Map([...t,...n])})(),b=new Proxy(s,{get:(n,o)=>{var i;return Q(e),"createElement"===o?p:"createElementNS"===o?h:o===Symbol.toStringTag?"ProxyDocument":"defaultView"===o?t.proxyWindow:"onclick"===o?r:"addEventListener"===o?d:"removeEventListener"===o?m:"microAppElement"===o?null===(i=In.get(e))||void 0===i?void 0:i.container:"__MICRO_APP_NAME__"===o?e:vt(Reflect.get(n,o),s,"DOCUMENT")},set:(e,t,n)=>{if(g.has(t)){g.get(t)(n)}else"microAppElement"!==t&&Reflect.set(e,t,n);return!0}});return{proxyDocument:b,documentEffect:{reset:f,record:_,rebuild:w,release:y}}}(e,n),i=function(e,t){const{rawDocument:n,rawRootDocument:o}=Gn;class r{static[Symbol.hasInstance](e){let n=e;for(;n;)if(n=Object.getPrototypeOf(n),n===r.prototype)return!0;return e===t||e instanceof o}}return Object.setPrototypeOf(r,o),Object.setPrototypeOf(r.prototype,new Proxy(o.prototype,{get:(t,o)=>(Q(e),vt(Reflect.get(t,o),n,"DOCUMENT")),set:(e,t,n)=>(Reflect.set(e,t,n),!0)})),r}(e,o);return c(t,{document:{configurable:!1,enumerable:!0,get:()=>o},Document:{configurable:!1,enumerable:!1,get:()=>i}}),r}function Pt(e,t,n){return function(e){const t=Gn.rawWindow;Object.getOwnPropertyNames(t).filter((e=>/^on/.test(e)&&!He.includes(e))).forEach((n=>{const{enumerable:o,writable:r,set:i}=Object.getOwnPropertyDescriptor(t,n)||{enumerable:!0,writable:!0};a(e,n,{enumerable:o,configurable:!0,get:()=>t[n],set:(null!=r?r:i)?e=>{t[n]=e}:void 0})}))}(t),function(e,t,n){const o=Gn.rawWindow,r=new Map,i=new Proxy(t,{get:(t,r)=>(Q(e),Reflect.has(t,r)||m(r)&&/^__MICRO_APP_/.test(r)||N(n.scopeProperties,r)?(N(Ke,r)&&G(),Reflect.get(t,r)):vt(Reflect.get(o,r),o)),set:(e,t,r)=>{if(N(n.rawWindowScopeKeyList,t))Reflect.set(o,t,r);else if(u.call(e,t)||!u.call(o,t)||N(n.scopeProperties,t))Reflect.has(e,t)&&!N(n.scopeProperties,t)||n.injectedKeys.add(t),Reflect.set(e,t,r);else{const i=Object.getOwnPropertyDescriptor(o,t),{configurable:s,enumerable:c,writable:l,set:u}=i;a(e,t,{value:r,configurable:s,enumerable:c,writable:null!=l?l:!!u}),n.injectedKeys.add(t)}return(N(n.escapeProperties,t)||N(n.staticEscapeProperties,t)&&!Reflect.has(o,t))&&!N(n.scopeProperties,t)&&(!Reflect.has(o,t)&&n.escapeKeys.add(t),Reflect.set(o,t,r)),!0},has:(e,t)=>N(n.scopeProperties,t)?n.injectedKeys.has(t)?Reflect.has(e,t):!!e[t]:Reflect.has(e,t)||Reflect.has(o,t),getOwnPropertyDescriptor:(e,t)=>{if(u.call(e,t))return r.set(t,"target"),Object.getOwnPropertyDescriptor(e,t);if(u.call(o,t)){r.set(t,"rawWindow");const e=Object.getOwnPropertyDescriptor(o,t);return e&&!e.configurable&&(e.configurable=!0),e}},defineProperty:(e,t,n)=>"rawWindow"===r.get(t)?Reflect.defineProperty(o,t,n):Reflect.defineProperty(e,t,n),ownKeys:e=>Reflect.ownKeys(o).concat(Reflect.ownKeys(e)).filter((function(e){return!(e in this)&&(this[e]=!0)}),Object.create(null)),deleteProperty:(e,t)=>!u.call(e,t)||(n.injectedKeys.has(t)&&n.injectedKeys.delete(t),n.escapeKeys.has(t)&&Reflect.deleteProperty(o,t),Reflect.deleteProperty(e,t))});n.proxyWindow=i}(e,t,n),function(e,t){const n=new Map,o=new Map,r=new Map,i=new Map,{rawWindow:s,rawAddEventListener:a,rawRemoveEventListener:c,rawDispatchEvent:l,rawSetInterval:u,rawSetTimeout:p,rawClearInterval:h,rawClearTimeout:d}=Gn;function m(e){var n;return ke.includes(e)&&(null===(n=In.get(t))||void 0===n?void 0:n.container)?Y(In.get(t).container):s}e.addEventListener=function(e,t,o){const r=n.get(e);r?r.add(t):n.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=o),a.call(m(e),e,t,o)},e.removeEventListener=function(e,t,o){const r=n.get(e);(null==r?void 0:r.size)&&r.has(t)&&r.delete(t),c.call(m(e),e,t,o)},e.dispatchEvent=function(e){return l.call(m(null==e?void 0:e.type),e)},e.setInterval=function(e,t,...n){const o=u.call(s,e,t,...n);return r.set(o,{handler:e,timeout:t,args:n}),o},e.setTimeout=function(e,t,...n){const o=p.call(s,e,t,...n);return i.set(o,{handler:e,timeout:t,args:n}),o},e.clearInterval=function(e){r.delete(e),h.call(s,e)},e.clearTimeout=function(e){i.delete(e),d.call(s,e)};const f=()=>{o.clear()},_=()=>{o.forEach(((t,n)=>{for(const o of t)e.addEventListener(n,o,null==o?void 0:o.__MICRO_APP_MARK_OPTIONS__)})),f()};return{reset:f,record:()=>{n.forEach(((e,t)=>{if(e.size){const n=o.get(t)||[];o.set(t,new Set([...n,...e]))}}))},rebuild:_,release:e=>{n.size&&(n.forEach(((e,t)=>{for(const n of e)c.call(m(t),t,n)})),n.clear()),e&&(r.forEach(((e,t)=>{h.call(s,t)})),i.forEach(((e,t)=>{d.call(s,t)})),r.clear(),i.clear())}}}(t,e)}function Rt(e,t){if(Bt(e)){const n=Gn.rawWindow.history.state,o={microAppState:s({},null==n?void 0:n.microAppState,{[e]:t})};return s({},n,o)}return t}function St(e){var t;const n=Gn.rawWindow.history.state;return Bt(e)?(null===(t=null==n?void 0:n.microAppState)||void 0===t?void 0:t[e])||null:n}const Mt=/&/g,Ct=/=/g,Nt=/%M1/g,Ot=/%M2/g;function Dt(e){return encodeURIComponent(xt(e).replace(Mt,"%M1").replace(Ct,"%M2"))}function It(e){return xt(e).replace(Nt,"&").replace(Ot,"=")}function xt(e){try{const t=decodeURIComponent(e);return e===t||Nt.test(t)||Ot.test(t)?t:xt(t)}catch(t){return e}}function Lt(e){var t,n;if(Ht(e))return null;const o=Gn.rawWindow.location;if(Bt(e)){const r=Wt(o.search,o.hash),i=(null===(t=r.hashQuery)||void 0===t?void 0:t[e])||(null===(n=r.searchQuery)||void 0===n?void 0:n[e]);return m(i)?It(i):null}return o.pathname+o.search+o.hash}function Tt(e,t){const n=t.pathname+t.search+t.hash;let o=!1;if(Bt(e)){let{pathname:t,search:r,hash:i}=Gn.rawWindow.location;const s=Wt(r,i),a=Dt(n);if(i&&!r){o=!0,s.hashQuery?s.hashQuery[e]=a:s.hashQuery={[e]:a};const t=i.includes("?")?i.slice(0,i.indexOf("?")+1):i+"?";i=t+te(s.hashQuery)}else s.searchQuery?s.searchQuery[e]=a:s.searchQuery={[e]:a},r="?"+te(s.searchQuery);return{fullPath:t+r+i,isAttach2Hash:o}}return{fullPath:n,isAttach2Hash:o}}function Wt(e,t){const n={};return""!==e&&"?"!==e&&(n.searchQuery=ee(e.slice(1))),t.includes("?")&&(n.hashQuery=ee(t.slice(t.indexOf("?")+1))),n}function Ut(e){const t=In.get(e);return!(!t||t.isPrefetch)}function Bt(e){const t=In.get(e);return!(!t||!t.sandBox||t.routerMode!==Le)}function kt(e){const t=In.get(e);return!(!t||!t.sandBox||t.routerMode!==Te)}function Ht(e){const t=In.get(e);return!(!t||!t.sandBox||t.routerMode!==Ue)}function Ft(e){return kt(e)||function(e){const t=In.get(e);return!(!t||!t.sandBox||t.routerMode!==We)}(e)}function $t(e,t){const n=t&&Te||e||io.options["disable-memory-router"]&&Te||io.options["router-mode"]||Le;return Be.includes(n)?n:Le}function jt(e){const t=Gn.rawWindow,n=t=>{Yn({excludeHiddenApp:!0,excludePreRender:!0}).includes(e)&&!t.onlyForBrowser&&Kt(e,Lt(e))};return t.addEventListener("popstate",n),()=>{t.removeEventListener("popstate",n)}}function Kt(e,t){const n=In.get(e),o=n.sandBox.proxyWindow,r=n.sandBox.microAppWindow;let i=!1;const s=o.location.href;if(t){const n=o.location.hash;mn(e,t,r.location),i=o.location.hash!==n}!function(e,t,n){const o=new PopStateEvent("popstate",{state:St(e)});n.dispatchEvent(o),Ln(e)||A(t.onpopstate)&&t.onpopstate(o)}(e,o,r),i&&function(e,t,n,o){const r=new HashChangeEvent("hashchange",{newURL:t.location.href,oldURL:o});n.dispatchEvent(r),Ln(e)||A(t.onhashchange)&&t.onhashchange(r)}(e,o,r,s),G()}function qt(e,t,n){G(),Ut(e)&&(function(e){const t=new PopStateEvent("popstate",{state:null});e&&(t.onlyForBrowser=!0),Gn.rawWindow.dispatchEvent(t)}(t),n&&function(e){const t=new HashChangeEvent("hashchange",{newURL:Gn.rawWindow.location.href,oldURL:e});Gn.rawWindow.dispatchEvent(t)}(n))}function Gt(e,t){const n=Gn.rawWindow.history;function o(n){return function(...o){var r,i,s;if(m(o[2])||v(o[2])){const a=x(o[2],t.href),c=a.pathname+a.search+a.hash;Ht(e)||Xt(e,n,Tt(e,a),!0,Rt(e,o[0]),o[1]),c!==t.fullPath&&mn(e,c,t),null===(s=null===(r=In.get(e))||void 0===r?void 0:(i=r.sandBox).updateIframeBase)||void 0===s||s.call(i)}else Qt(e,n,o[2],o[0],o[1])}}const r=o("pushState"),i=o("replaceState");return Ln(e)?{pushState:r,replaceState:i}:new Proxy(n,{get:(t,n)=>"state"===n?St(e):"pushState"===n?r:"replaceState"===n?i:vt(Reflect.get(t,n),t,"HISTORY"),set:(e,t,n)=>(Reflect.set(e,t,n),!0)})}function Qt(e,t,n,o=null,r=""){if(Ut(e)){("pushState"===t?Gn.rawPushState:Gn.rawReplaceState).call(Gn.rawWindow.history,o,r,n)}}function Xt(e,t,n,o,r,i){if(Ut(e)){const s=Gn.rawWindow.location,a=s.pathname+s.search+s.hash,c=n.isAttach2Hash&&a!==n.fullPath?s.href:null;Qt(e,t,n.fullPath,r,i),a!==n.fullPath&&Bt(e)&&qt(e,o,c)}}function zt(e,t,n){Xt(e,"replaceState",t,!0,n)}function Vt(e){const t=Gn.rawWindow;return function(...n){var o;if((null===(o=t.history.state)||void 0===o?void 0:o.microAppState)&&(!w(n[0])||!n[0].microAppState)&&(m(n[2])||v(n[2]))){const e=t.location.href;x(n[2],e).href===e&&(n[0]=s({},n[0],{microAppState:t.history.state.microAppState}))}e.apply(t.history,n),Yn({excludeHiddenApp:!0,excludePreRender:!0}).forEach((e=>{if(Bt(e)&&!Lt(e)){zt(e,Tt(e,In.get(e).sandBox.proxyWindow.location),Rt(e,St(e)))}})),G()}}function Yt(){const e=Gn.rawWindow;e.history.pushState=Vt(Gn.rawPushState),e.history.replaceState=Vt(Gn.rawReplaceState)}function Jt(){const e=Gn.rawWindow;e.history.pushState=Gn.rawPushState,e.history.replaceState=Gn.rawReplaceState}const{router:Zt,executeNavigationGuard:en,clearRouterWhenUnmount:tn}=function(){function e(e,t,n,o){const r=t.sandBox.proxyWindow.location,i=x(n.path,r.href),s=r.pathname+r.search+r.hash,a=i.pathname+i.search+i.hash;if(s!==a||Lt(e)!==a){if(!Ht(e)){!function(e,t,n,o){Xt(e,t,Tt(e,n),!1,Rt(e,null!=o?o:null)),G()}(e,o&&!1!==n.replace||!0===n.replace?"replaceState":"pushState",i,n.state)}(Ft(e)||Ht(e))&&Kt(e,a)}}function t(t){return function(n){return new Promise(((o,r)=>{const i=W(n.name);if(i&&m(n.path))if(Yn({excludeHiddenApp:!0,excludePreRender:!0}).includes(i)){const r=In.get(i);o(r.sandBox.sandboxReady.then((()=>e(i,r,n,t))))}else r(O("navigation failed, app does not exist or is inactive"));else r(O("navigation failed, name & path are required when use router."+(t?"replace":"push")))}))}}function n(e){return function(...t){return Gn.rawWindow.history[e](...t)}}const o=ne(),i=ne();function s(e,t,n,o){G();for(const r of o)A(r)?r(t,n,e):w(r)&&A(r[e])&&r[e](t,n)}function a(e){if(Bt(e)){zt(e,Tt(e,In.get(e).sandBox.proxyWindow.location),Rt(e,St(e)))}}const c=Object.assign(Object.assign({current:new Map,encode:Dt,decode:It,push:t(!1),replace:t(!0),go:n("go"),back:n("back"),forward:n("forward"),beforeEach:o.add,afterEach:i.add,attachToURL:function(e){(e=W(e))&&Yn().includes(e)&&a(e)},attachAllToURL:function({includeHiddenApp:e=!1,includePreRender:t=!1}){Yn({excludeHiddenApp:!e,excludePreRender:!t}).forEach((e=>a(e)))}},function(){const e=function(){const e=new Map;return{add:function(t,n){return e.set(t,n),()=>!!e.has(t)&&e.delete(t)},get:t=>e.get(t),delete:t=>!!e.has(t)&&e.delete(t)}}();return{setDefaultPage:function(t){const n=W(t.name);return n&&t.path?e.add(n,t.path):r},removeDefaultPage:function(t){return!!(t=W(t))&&e.delete(t)},getDefaultPage:e.get}}()),function(){let e=null;return{setBaseAppRouter:function(t){y(t)&&(e=new Proxy(t,{get:(e,t)=>(G(),vt(Reflect.get(e,t),e,"BASEROUTER")),set:(e,t,n)=>(Reflect.set(e,t,n),!0)}))},getBaseAppRouter:()=>e}}());return{router:c,executeNavigationGuard:function(e,t,n){c.current.set(e,t),s(e,t,n,o.list()),H((()=>{s(e,t,n,i.list())}))},clearRouterWhenUnmount:function(e){c.current.delete(e)}}}(),nn=["getComputedStyle","visualViewport","matchMedia","ResizeObserver","IntersectionObserver"],on=[/animationFrame$/i,/mutationObserver$/i,/height$|width$/i,/offset$/i,/selection$/i,/^range/i,/^screen/i,/^scroll/i,/X$|Y$/],rn=["body","head","html","title"],sn=["host","hostname","port","protocol","origin"],an=["childElementCount","children","firstElementChild","firstChild","lastElementChild","activeElement","fullscreenElement","pictureInPictureElement","pointerLockElement","styleSheets"],cn=["append","contains","replaceChildren","createRange","getSelection","elementFromPoint","elementsFromPoint","getAnimations"],ln=["characterSet","compatMode","contentType","designMode","dir","doctype","embeds","fullscreenEnabled","hidden","implementation","lastModified","pictureInPictureEnabled","plugins","readyState","referrer","visibilityState","fonts"],un=["execCommand","createRange","exitFullscreen","exitPictureInPicture","getElementsByTagNameNS","hasFocus","prepend"],pn=["href","pathname","search","hash","host","hostname","port","protocol","search","origin","fullPath"];function hn(e,t,n,o,r,i){const s=Gn.rawWindow.location,c=!!n,l=x(t);function u(){return c?n.location:l}function p(t,n){const o=x(t,A.href);if(o.origin===A.origin){const t=Tt(e,o);if(Bt(e)){if(o.pathname===A.pathname&&o.search===A.search){let r=null;return o.hash!==A.hash&&(t.isAttach2Hash&&(r=s.href),Qt(e,n,t.fullPath)),void(o.hash?qt(e,!1,r):_())}if(t.isAttach2Hash)return Qt(e,n,t.fullPath),void _()}return t.fullPath}return t}function h(n,o){const r=x(n,t);r[o]===A[o]&&A.hash?qt(e,!1):(Qt(e,r[o]===A[o]?"replaceState":"pushState",Tt(e,r).fullPath),_())}const d=t=>function(n){if(Ut(e)){const e=p(n,"assign"===t?"pushState":"replaceState");e&&s[t](x(e,s.origin).href)}},m=d("assign"),f=d("replace"),_=e=>s.reload(e);a(u(),"fullPath",{enumerable:!0,configurable:!0,get:()=>A.pathname+A.search+A.hash});const A=new Proxy({},{get:(t,n)=>{const a=u();if("assign"===n)return m;if("replace"===n)return f;if("reload"===n)return _;if("self"===n)return a;if("fullPath"===n)return a.fullPath;if(kt(e))return vt(Reflect.get(s,n),s,"LOCATION");if(c){if(sn.includes(n))return o[n];if("href"===n)return a[n].replace(r,i)}return vt(Reflect.get(a,n),a,"LOCATION")},set:(n,o,r)=>{if(Ut(e)){const n=u();if("href"===o){const e=p(r,"pushState");e&&(s.href=x(e,s.origin).href)}else if("pathname"===o)if(Ft(e))s.pathname=r;else{h(("/"+r).replace(/^\/+/,"/")+A.search+A.hash,"pathname")}else if("search"===o)if(Ft(e))s.search=r;else{h(A.pathname+("?"+r).replace(/^\?+/,"?")+A.hash,"search")}else if("hash"===o)if(Ft(e))s.hash=r;else{const n=A.pathname+A.search+("#"+r).replace(/^#+/,"#"),o=x(n,t);o.hash!==A.hash&&Xt(e,"pushState",Tt(e,o),!1)}else Reflect.set(n,o,r)}return!0}});return A}function dn(e,t){const n=s({name:e},t);for(const e of pn)n[e]=t[e];return n}function mn(e,t,n,o){var r;const i=dn(e,n),s=x(t,n.href);if(Ln(e)){const t=In.get(e).sandBox.microAppWindow;null===(r=t.rawReplaceState)||void 0===r||r.call(t.history,St(e),"",s.href)}else{let e=s.href;n.self.origin!==s.origin&&(e=e.replace(s.origin,n.self.origin)),n.self.href=e}const a=dn(e,n);("auto"===o||i.fullPath!==a.fullPath&&"prevent"!==o)&&en(e,a,i)}function fn(e,t,n){const o=Lt(e);o?mn(e,o,t,"auto"):_n(e,t,n)}function _n(e,t,n){n&&mn(e,n,t,"prevent"),Ht(e)||zt(e,Tt(e,t),Rt(e,null)),function(e,t){en(e,dn(e,t),dn(e,t))}(e,t)}function An(e,t,n,o){if(!Ft(e)){if(!o){const{pathname:o,search:r,hash:i}=x(t);mn(e,o+r+i,n,"prevent")}Ht(e)||wn(e)}tn(e)}function wn(e){zt(e,function(e,t){var n,o,r,i;let{pathname:s,search:a,hash:c}=t||Gn.rawWindow.location,l=!1;if(Bt(e)){const t=Wt(a,c);if(null===(n=t.hashQuery)||void 0===n?void 0:n[e]){l=!0,null===(o=t.hashQuery)||void 0===o||delete o[e];const n=te(t.hashQuery);c=c.slice(0,c.indexOf("?")+Number(Boolean(n)))+n}else if(null===(r=t.searchQuery)||void 0===r?void 0:r[e]){null===(i=t.searchQuery)||void 0===i||delete i[e];const n=te(t.searchQuery);a=n?"?"+n:""}}return{fullPath:s+a+c,isAttach2Hash:l}}(e),function(e,t){return Bt(e)?(w(null==t?void 0:t.microAppState)&&(h(t.microAppState[e])||delete t.microAppState[e],Object.keys(t.microAppState).length||delete t.microAppState),s({},t)):t}(e,Gn.rawWindow.history.state))}class yn{constructor(){this.rawWindowScopeKeyList=["location"],this.staticEscapeProperties=["System","__cjsWrapper"],this.staticScopeProperties=["webpackJsonp","webpackHotUpdate","Vue","onpopstate","onhashchange"],this.scopeProperties=Array.from(this.staticScopeProperties),this.escapeProperties=[],this.injectedKeys=new Set,this.escapeKeys=new Set,this.injectReactHMRProperty()}injectReactHMRProperty(){}}class gn{}function bn(e,t){const n=Array.from(e.children);n.length&&n.forEach((e=>{bn(e,t)}));for(const e of n)vn(e,t)}function vn(e,t){var n,o;const r=null===(o=null===(n=In.get(t))||void 0===n?void 0:n.sandBox)||void 0===o?void 0:o.proxyWindow;return P(e)&&!e.__MICRO_APP_NAME__&&!e.__PURE_ELEMENT__&&r&&c(e,{baseURI:{configurable:!0,get:()=>r.location.href},__MICRO_APP_NAME__:{configurable:!0,writable:!0,value:t}}),e}function En(e,t){const n=h(t)?Gn.rawWindow.fetch:t;return A(n)?function(t,o,...r){return(m(t)||v(t))&&(t=x(t,e).toString()),G(),n.call(Gn.rawWindow,t,o,...r)}:n}function Pn(e,t){const n=h(t)?Gn.rawWindow.XMLHttpRequest:t;return b(n)?class extends n{open(t,n,...o){(m(n)&&!/^f(ile|tp):\/\//.test(n)||v(n))&&(n=x(n,e).toString()),G(),super.open(t,n,...o)}}:n}const{createMicroEventSource:Rn,clearMicroEventSource:Sn}=function(){let e;return{createMicroEventSource:function(t,n,o){const r=h(o)?Gn.rawWindow.EventSource:o;return b(r)?class extends r{constructor(o,r,...i){if((m(o)||v(o))&&(o=x(o,n).toString()),G(),super(o,r,...i),e){const n=e.get(t);n?n.add(this):e.set(t,new Set([this]))}else e=new Map([[t,new Set([this])]])}close(){var n;super.close(),null===(n=e.get(t))||void 0===n||n.delete(this)}}:r},clearMicroEventSource:function(t){const n=null==e?void 0:e.get(t);(null==n?void 0:n.size)&&(n.forEach((e=>{e.close()})),n.clear())}}}();class Mn extends yn{constructor(e,t){super(),this.active=!1,this.microAppWindow=new gn,this.patchWith((n=>{this.getSpecialProperties(e),this.patchRouter(e,t,this.microAppWindow),this.windowEffect=Pt(e,this.microAppWindow,this),this.documentEffect=Et(e,this.microAppWindow,this),this.setMappingPropertiesWithRawDescriptor(this.microAppWindow),this.initStaticGlobalKeys(e,t,this.microAppWindow),n()}))}start({umdMode:e,baseroute:t,defaultPage:n,disablePatchRequest:o}){this.active||(this.active=!0,this.initRouteState(n),this.removeHistoryListener=jt(this.microAppWindow.__MICRO_APP_NAME__),Ft(this.microAppWindow.__MICRO_APP_NAME__)&&(this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=t),e||this.initGlobalKeysWhenStart(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow,o),1==++Gn.activeSandbox&&($n(),Yt()),1==++Mn.activeCount&&window.__MICRO_APP_ENVIRONMENT__&&(gt(),window.addEventListener("unmount",yt,!1)),Gn.rawWindow._babelPolyfill&&(Gn.rawWindow._babelPolyfill=!1))}stop({umdMode:e,keepRouteState:t,destroy:n,clearData:o}){var r;this.active&&(this.recordAndReleaseEffect({umdMode:e,clearData:o,destroy:n},!e||n),this.clearRouteState(t),null===(r=this.removeHistoryListener)||void 0===r||r.call(this),e&&!n||(Sn(this.microAppWindow.__MICRO_APP_NAME__),this.injectedKeys.forEach((e=>{Reflect.deleteProperty(this.microAppWindow,e)})),this.injectedKeys.clear(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(Gn.rawWindow,e)})),this.escapeKeys.clear()),0==--Gn.activeSandbox&&(Kn(),Jt()),--Mn.activeCount,this.active=!1)}initStaticGlobalKeys(e,t,n){n.__MICRO_APP_ENVIRONMENT__=!0,n.__MICRO_APP_NAME__=e,n.__MICRO_APP_URL__=t,n.__MICRO_APP_PUBLIC_PATH__=U(t),n.__MICRO_APP_BASE_ROUTE__="",n.__MICRO_APP_WINDOW__=n,n.__MICRO_APP_PRE_RENDER__=!1,n.__MICRO_APP_UMD_MODE__=!1,n.__MICRO_APP_PROXY_WINDOW__=this.proxyWindow,n.__MICRO_APP_SANDBOX__=this,n.__MICRO_APP_SANDBOX_TYPE__="with",n.rawWindow=Gn.rawWindow,n.rawDocument=Gn.rawDocument,n.microApp=s(new mt(e),{removeDomScope:G,pureCreateElement:X,router:Zt})}recordAndReleaseEffect(e,t=!1){t?this.resetEffectSnapshot():this.recordEffectSnapshot(),this.releaseGlobalEffect(e)}resetEffectSnapshot(){this.windowEffect.reset(),this.documentEffect.reset(),At(this.microAppWindow.microApp)}recordEffectSnapshot(){this.windowEffect.record(),this.documentEffect.record(),ft(this.microAppWindow.microApp)}rebuildEffectSnapshot(){this.windowEffect.rebuild(),this.documentEffect.rebuild(),_t(this.microAppWindow.microApp)}releaseGlobalEffect({umdMode:e=!1,clearData:t=!1,isPrerender:n=!1,keepAlive:o=!1,destroy:r=!1}){var i,s,a;this.windowEffect.release(!e&&!o&&!n||r),this.documentEffect.release(),null===(i=this.microAppWindow.microApp)||void 0===i||i.clearDataListener(),null===(s=this.microAppWindow.microApp)||void 0===s||s.clearGlobalDataListener(),t&&(io.clearData(this.microAppWindow.__MICRO_APP_NAME__),null===(a=this.microAppWindow.microApp)||void 0===a||a.clearData())}getSpecialProperties(e){var t;w(io.options.plugins)&&(this.commonActionForSpecialProperties(io.options.plugins.global),this.commonActionForSpecialProperties(null===(t=io.options.plugins.modules)||void 0===t?void 0:t[e]))}commonActionForSpecialProperties(e){if(i(e))for(const t of e)w(t)&&(i(t.scopeProperties)&&(this.scopeProperties=this.scopeProperties.concat(t.scopeProperties)),i(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties)))}setPreRenderState(e){this.microAppWindow.__MICRO_APP_PRE_RENDER__=e}markUmdMode(e){this.microAppWindow.__MICRO_APP_UMD_MODE__=e}patchWith(e){this.sandboxReady=new Promise((t=>e(t)))}setMappingPropertiesWithRawDescriptor(e){let t,n;const o=Gn.rawWindow;o===o.parent?t=n=this.proxyWindow:(t=o.top,n=o.parent),c(e,{top:this.createDescriptorForMicroAppWindow("top",t),parent:this.createDescriptorForMicroAppWindow("parent",n)}),je.forEach((t=>{a(e,t,this.createDescriptorForMicroAppWindow(t,this.proxyWindow))}))}createDescriptorForMicroAppWindow(e,t){const{configurable:n=!0,enumerable:o=!0,writable:r,set:i}=Object.getOwnPropertyDescriptor(Gn.rawWindow,e)||{writable:!0};return{value:t,configurable:n,enumerable:o,writable:null!=r?r:!!i}}initGlobalKeysWhenStart(e,t,n,o){n.hasOwnProperty=e=>u.call(n,e)||u.call(Gn.rawWindow,e),this.setHijackProperty(e,n),o||this.patchRequestApi(e,t,n),this.setScopeProperties(n)}setHijackProperty(e,t){let n,o;c(t,{eval:{configurable:!0,enumerable:!1,get:()=>(Q(e),n||Gn.rawWindow.eval),set:e=>{n=e}},Image:{configurable:!0,enumerable:!1,get:()=>(Q(e),o||Gn.ImageProxy),set:e=>{o=e}}})}patchRequestApi(e,t,n){let o=En(t),r=Pn(t),i=Rn(e,t);c(n,{fetch:{configurable:!0,enumerable:!0,get:()=>o,set(e){o=En(t,e)}},XMLHttpRequest:{configurable:!0,enumerable:!0,get:()=>r,set(e){r=Pn(t,e)}},EventSource:{configurable:!0,enumerable:!0,get:()=>i,set(n){i=Rn(e,t,n)}}})}setScopeProperties(e){this.scopeProperties.forEach((t=>{Reflect.set(e,t,e[t])}))}patchRouter(e,t,n){const{microLocation:o,microHistory:r}=function(e,t){const n=hn(e,t);return{microLocation:n,microHistory:Gt(e,n)}}(e,t);c(n,{location:{configurable:!1,enumerable:!0,get:()=>o,set:e=>{Gn.rawWindow.location=e}},history:{configurable:!0,enumerable:!0,get:()=>r}})}initRouteState(e){fn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location,e)}clearRouteState(e){An(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow.location,e)}setRouteInfoForKeepAliveApp(){_n(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location)}removeRouteInfoForKeepAliveApp(){wn(this.microAppWindow.__MICRO_APP_NAME__)}patchStaticElement(e){bn(e,this.microAppWindow.__MICRO_APP_NAME__)}actionBeforeExecScripts(e){this.patchStaticElement(e)}setStaticAppState(e){this.microAppWindow.__MICRO_APP_STATE__=e}}function Cn(e,t,n){return function(e,t){const n=Gn.rawWindow;nn.forEach((e=>{t[e]=vt(n[e],n)})),Object.getOwnPropertyNames(t).filter((e=>(on.some((o=>{if(o.test(e)&&e in t.parent){if(A(n[e]))t[e]=vt(n[e],n);else{const{configurable:o,enumerable:r}=Object.getOwnPropertyDescriptor(t,e)||{configurable:!0,enumerable:!0};o&&a(t,e,{configurable:o,enumerable:r,get:()=>n[e],set:t=>{n[e]=t}})}return!0}return!1})),/^on/.test(e)&&!He.includes(e)))).forEach((o=>{const{enumerable:r,writable:i,set:s}=Object.getOwnPropertyDescriptor(t,o)||{enumerable:!0,writable:!0};try{a(t,o,{enumerable:r,configurable:!0,get:()=>n[o],set:(null!=i?i:s)?e=>{n[o]=A(e)?e.bind(t):e}:void 0})}catch(t){D(t,e)}}))}(e,t),function(e,t){const n=Gn.rawWindow,o=new Set,r=new Proxy(e,{get:(e,i)=>"location"===i?t.proxyLocation:N(je,i)?r:o.has(i)?Reflect.get(e,i):N(t.escapeProperties,i)&&!Reflect.has(e,i)?vt(Reflect.get(n,i),n):vt(Reflect.get(e,i),e),set:(e,r,i)=>"location"===r?Reflect.set(n,r,i):(Reflect.has(e,r)||o.add(r),Reflect.set(e,r,i),N(t.escapeProperties,r)&&(!Reflect.has(n,r)&&t.escapeKeys.add(r),Reflect.set(n,r,i)),!0),has:(e,t)=>t in e,deleteProperty:(e,o)=>!Reflect.has(e,o)||(t.escapeKeys.has(o)&&Reflect.deleteProperty(n,o),Reflect.deleteProperty(e,o))});t.proxyWindow=r}(t,n),function(e){const{rawWindow:t,rawAddEventListener:n,rawRemoveEventListener:o}=Gn,r=new Map,i=new Map;function s(n){return ke.includes(n)?e:t}e.addEventListener=function(e,t,o){const i=r.get(e);i?i.add(t):r.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=o),n.call(s(e),e,t,o)},e.removeEventListener=function(e,t,n){const i=r.get(e);(null==i?void 0:i.size)&&i.has(t)&&i.delete(t),o.call(s(e),e,t,n)};const a=()=>{i.clear()},c=()=>{i.forEach(((t,n)=>{for(const o of t)e.addEventListener(n,o,null==o?void 0:o.__MICRO_APP_MARK_OPTIONS__)})),a()};return{reset:a,record:()=>{r.forEach(((e,t)=>{if(e.size){const n=i.get(t)||[];i.set(t,new Set([...n,...e]))}}))},rebuild:c,release:()=>{r.size&&(r.forEach(((e,t)=>{for(const n of e)o.call(s(t),t,n)})),r.clear())}}}(t)}function Nn(e,t,n){return function(e,t){const n=Gn.rawDocument,o=t.Document,r=t.document,i=o.prototype.createElement,s=o.prototype.createElementNS,a=o.prototype.createTextNode,c=o.prototype.createDocumentFragment,l=o.prototype.createComment,u=o.prototype.querySelector,p=o.prototype.querySelectorAll,h=o.prototype.getElementById,d=o.prototype.getElementsByClassName,m=o.prototype.getElementsByTagName,f=o.prototype.getElementsByName,_=o.prototype.elementFromPoint,A=o.prototype.caretRangeFromPoint;function w(e){return r!==e?e:n}function y(t){var n,o;if(!t||V(t)||r!==this){const e=w(this);return u.call(e,t)}return null!==(o=null===(n=In.get(e))||void 0===n?void 0:n.querySelector(t))&&void 0!==o?o:null}function g(t){var n,o;if(!t||V(t)||r!==this){const e=w(this);return p.call(e,t)}return null!==(o=null===(n=In.get(e))||void 0===n?void 0:n.querySelectorAll(t))&&void 0!==o?o:[]}o.prototype.caretRangeFromPoint=function(t,o){const r=_.call(n,t,o),i=A.call(n,t,o);return vn(r,e),i},o.prototype.createElement=function(t,n){return vn(i.call(this,t,n),e)},o.prototype.createElementNS=function(t,n,o){return vn(s.call(this,t,n,o),e)},o.prototype.createTextNode=function(t){return vn(a.call(this,t),e)},o.prototype.createDocumentFragment=function(){return vn(c.call(this),e)},o.prototype.createComment=function(t){return vn(l.call(this,t),e)},o.prototype.querySelector=y,o.prototype.querySelectorAll=g,o.prototype.getElementById=function(e){const t=w(this);if(z(e))return h.call(t,e);try{return y.call(this,`#${e}`)}catch(n){return h.call(t,e)}},o.prototype.getElementsByClassName=function(e){const t=w(this);if(z(e))return d.call(t,e);try{return g.call(this,`.${e}`)}catch(n){return d.call(t,e)}},o.prototype.getElementsByTagName=function(e){const t=w(this);if(V(e)||z(e))return m.call(t,e);if(/^script|base$/i.test(e))return m.call(r,e);try{return g.call(this,e)}catch(n){return m.call(t,e)}},o.prototype.getElementsByName=function(e){const t=w(this);if(z(e))return f.call(t,e);try{return g.call(this,`[name=${e}]`)}catch(n){return f.call(t,e)}}}(e,t),function(e,t,n){const o=Gn.rawDocument,r=t.Document,i=t.document,s=(e,t)=>{const{enumerable:n}=Object.getOwnPropertyDescriptor(r.prototype,e)||{enumerable:!0};return{configurable:!0,enumerable:n,get:t}},l=()=>{const t={};return[["documentURI",()=>n.proxyLocation.href],["URL",()=>n.proxyLocation.href],["documentElement",()=>o.documentElement],["scrollingElement",()=>o.scrollingElement],["forms",()=>r.prototype.querySelectorAll.call(i,"form")],["images",()=>r.prototype.querySelectorAll.call(i,"img")],["links",()=>r.prototype.querySelectorAll.call(i,"a")],["microAppElement",()=>{var t;return null===(t=In.get(e))||void 0===t?void 0:t.container}],["__MICRO_APP_NAME__",()=>e]].forEach((e=>{t[e[0]]=s(e[0],e[1])})),an.forEach((e=>{t[e]=s(e,(()=>o[e]))})),cn.forEach((e=>{t[e]=s(e,(()=>vt(o[e],o,"DOCUMENT")))})),ln.forEach((e=>{t[e]=s(e,(()=>o[e]))})),un.forEach((e=>{t[e]=s(e,(()=>vt(o[e],o,"DOCUMENT")))})),t};c(r.prototype,l()),rn.forEach((t=>{a(i,t,{enumerable:!0,configurable:!0,get:()=>(Q(e),o[t]),set:e=>{o[t]=e}})}))}(e,t,n),function(e,t){const{rawDocument:n,rawAddEventListener:o,rawRemoveEventListener:r}=Gn,i=new Map,s=new Map;let c=null,l=null;const u=t.Document,p=t.document;function h(e,t){return Fe.includes(e)?t:n}function d(e){return"onclick"===e?e=>{A(c)&&r.call(n,"click",c,!1),A(e)?(c=e.bind(p),o.call(n,"click",c,!1)):c=e}:t=>{n[e]=A(t)?t.bind(p):t}}u.prototype.addEventListener=function(e,t,n){const r=A(t)?t.__MICRO_APP_BOUND_FUNCTION__=t.__MICRO_APP_BOUND_FUNCTION__||t.bind(this):t,s=i.get(e);s?s.add(t):i.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=n),o.call(h(e,this),e,r,n)},u.prototype.removeEventListener=function(e,t,n){const o=i.get(e);(null==o?void 0:o.size)&&o.has(t)&&o.delete(t);const s=(null==t?void 0:t.__MICRO_APP_BOUND_FUNCTION__)||t;r.call(h(e,this),e,s,n)},Object.getOwnPropertyNames(u.prototype).filter((e=>/^on/.test(e)&&!$e.includes(e))).forEach((t=>{const{enumerable:o,writable:r,set:i}=Object.getOwnPropertyDescriptor(u.prototype,t)||{enumerable:!0,writable:!0};try{a(u.prototype,t,{enumerable:o,configurable:!0,get:()=>"onclick"===t?c:n[t],set:(null!=r?r:i)?d(t):void 0})}catch(t){D(t,e)}}));const m=()=>{s.clear(),l=null},f=()=>{l&&!c&&(p.onclick=l),s.forEach(((e,t)=>{for(const n of e)p.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),m()};return{reset:m,record:()=>{l=c||l,i.forEach(((e,t)=>{if(e.size){const n=s.get(t)||[];s.set(t,new Set([...n,...e]))}}))},rebuild:f,release:()=>{A(c)&&r.call(n,"click",c),c=null,i.size&&(i.forEach(((e,t)=>{for(const n of e)r.call(h(t,p),t,(null==n?void 0:n.__MICRO_APP_BOUND_FUNCTION__)||n)})),i.clear())}}}(e,t)}function On(e,t,n,o){!function(e,t,n){const o=Gn.rawRootElement,r=Gn.rawDocument,i=t.document,s=t.Node,c=t.Element,l=s.prototype.appendChild,u=s.prototype.insertBefore,h=s.prototype.replaceChild,d=s.prototype.removeChild,m=c.prototype.append,f=c.prototype.prepend,_=c.prototype.insertAdjacentElement,A=s.prototype.cloneNode,w=Object.getOwnPropertyDescriptor(c.prototype,"innerHTML"),y=Object.getOwnPropertyDescriptor(s.prototype,"parentNode"),g=Object.getOwnPropertyDescriptor(s.prototype,"ownerDocument"),b=e=>(M(e)||function(e){return"[object HTMLBaseElement]"===p(e)}(e))&&e.__PURE_ELEMENT__,v=e=>e===n.microHead?r.head:e===n.microBody?r.body:e;s.prototype.getRootNode=function(){return i},s.prototype.appendChild=function(t){return vn(t,e),b(t)?l.call(this,t):o.prototype.appendChild.call(v(this),t)},s.prototype.insertBefore=function(t,n){return vn(t,e),b(t)?u.call(this,t,n):o.prototype.insertBefore.call(v(this),t,n)},s.prototype.replaceChild=function(t,n){return vn(t,e),b(t)?h.call(this,t,n):o.prototype.replaceChild.call(v(this),t,n)},s.prototype.removeChild=function(e){return b(e)||this.contains(e)?d.call(this,e):o.prototype.removeChild.call(v(this),e)},c.prototype.append=function(...e){let t=0,n=!1;for(;t<e.length;)e[t]=P(e[t])?e[t]:i.createTextNode(e[t]),b(e[t])&&(n=!0),t++;return n?m.call(this,...e):o.prototype.append.call(v(this),...e)},c.prototype.prepend=function(...e){let t=0,n=!1;for(;t<e.length;)e[t]=P(e[t])?e[t]:i.createTextNode(e[t]),b(e[t])&&(n=!0),t++;return n?f.call(this,...e):o.prototype.prepend.call(v(this),...e)},c.prototype.insertAdjacentElement=function(t,n){return vn(n,e),b(n)?_.call(this,t,n):o.prototype.insertAdjacentElement.call(v(this),t,n)},s.prototype.cloneNode=function(t){return vn(A.call(this,t),e)},a(s.prototype,"ownerDocument",{configurable:!0,enumerable:!0,get(){return this.__PURE_ELEMENT__?g.get.call(this):i}}),a(c.prototype,"innerHTML",{configurable:!0,enumerable:!0,get(){return w.get.call(this)},set(t){w.set.call(this,t),Array.from(this.children).forEach((t=>{E(t)&&vn(t,e)}))}}),a(s.prototype,"parentNode",{configurable:!0,enumerable:!0,get(){var t,n,o;Q(e);const r=y.get.call(this);return C(r)&&(null===(t=In.get(e))||void 0===t?void 0:t.container)?(null===(o=(n=io.options).getRootElementParentNode)||void 0===o?void 0:o.call(n,this,e))||Gn.rawDocument.body:r}});const R=new Proxy(t.Image,{construct(t,n){const o=new t(...n);return vn(o,e),o}});a(t,"Image",{configurable:!0,writable:!0,value:R})}(e,n,o),function(e,t){const n=t.Element,o=n.prototype.setAttribute;n.prototype.setAttribute=function(t,n){(("src"===t||"srcset"===t)&&/^(img|script)$/i.test(this.tagName)||"href"===t&&/^link$/i.test(this.tagName))&&(n=B(n,e)),o.call(this,t,n)};const r=[[t.HTMLImageElement.prototype,"src"],[t.HTMLScriptElement.prototype,"src"],[t.HTMLLinkElement.prototype,"href"]];r.forEach((([t,n])=>{const{enumerable:o,configurable:r,get:i,set:s}=Object.getOwnPropertyDescriptor(t,n)||{enumerable:!0,configurable:!0};a(t,n,{enumerable:o,configurable:r,get:function(){return null==i?void 0:i.call(this)},set:function(t){null==s||s.call(this,B(t,e))}})}))}(t,n)}Mn.activeCount=0;class Dn{constructor(e,t){this.active=!1,this.escapeProperties=[],this.escapeKeys=new Set,this.updateIframeBase=()=>{var e;null===(e=this.baseElement)||void 0===e||e.setAttribute("href",x(this.url).origin+this.proxyLocation.pathname)},this.appName=e,this.url=t;const n=Gn.rawWindow.location,o=n.protocol+"//"+n.host;this.deleteIframeElement=this.createIframeElement(e,o+n.pathname),this.microAppWindow=this.iframe.contentWindow,this.patchIframe(this.microAppWindow,(n=>{this.createIframeTemplate(this.microAppWindow),this.getSpecialProperties(e),this.proxyLocation=function(e,t,n,o){const r=x(t),i=r.protocol+"//"+r.host,a=r.pathname+r.search+r.hash,c=n.history;return n.rawReplaceState=c.replaceState,s(c,Gt(e,n.location)),mn(e,a,n.location,"prevent"),hn(e,t,n,r,o,i)}(e,t,this.microAppWindow,o),this.windowEffect=Cn(e,this.microAppWindow,this),this.documentEffect=Nn(e,this.microAppWindow,this),On(e,t,this.microAppWindow,this),this.initStaticGlobalKeys(e,t,this.microAppWindow),n()}))}createIframeElement(e,t){this.iframe=X("iframe");const n={src:io.options.iframeSrc||t,style:"display: none",id:e};return Object.keys(n).forEach((e=>this.iframe.setAttribute(e,n[e]))),Gn.rawDocument.body.appendChild(this.iframe),()=>I((()=>{var e,t;null===(t=null===(e=this.iframe)||void 0===e?void 0:e.parentNode)||void 0===t||t.removeChild(this.iframe),this.iframe=null}))}start({baseroute:e,defaultPage:t,disablePatchRequest:n}){this.active||(this.active=!0,this.initRouteState(t),this.removeHistoryListener=jt(this.microAppWindow.__MICRO_APP_NAME__),Ft(this.microAppWindow.__MICRO_APP_NAME__)&&(this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=e),n||this.createIframeBase(),1==++Gn.activeSandbox&&($n(),Yt()),++Dn.activeCount)}stop({umdMode:e,keepRouteState:t,destroy:n,clearData:o}){var r;this.active&&(this.recordAndReleaseEffect({clearData:o},!e||n),this.clearRouteState(t),null===(r=this.removeHistoryListener)||void 0===r||r.call(this),e&&!n||(this.deleteIframeElement(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(Gn.rawWindow,e)})),this.escapeKeys.clear()),0==--Gn.activeSandbox&&(Kn(),Jt()),--Dn.activeCount,this.active=!1)}initStaticGlobalKeys(e,t,n){n.__MICRO_APP_ENVIRONMENT__=!0,n.__MICRO_APP_NAME__=e,n.__MICRO_APP_URL__=t,n.__MICRO_APP_PUBLIC_PATH__=U(t),n.__MICRO_APP_BASE_ROUTE__="",n.__MICRO_APP_WINDOW__=n,n.__MICRO_APP_PRE_RENDER__=!1,n.__MICRO_APP_UMD_MODE__=!1,n.__MICRO_APP_PROXY_WINDOW__=this.proxyWindow,n.__MICRO_APP_SANDBOX__=this,n.__MICRO_APP_SANDBOX_TYPE__="iframe",n.rawWindow=Gn.rawWindow,n.rawDocument=Gn.rawDocument,n.microApp=s(new mt(e),{removeDomScope:G,pureCreateElement:X,location:this.proxyLocation,router:Zt})}recordAndReleaseEffect(e,t=!1){t?this.resetEffectSnapshot():this.recordEffectSnapshot(),this.releaseGlobalEffect(e)}resetEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.reset(),null===(t=this.documentEffect)||void 0===t||t.reset(),At(this.microAppWindow.microApp)}recordEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.record(),null===(t=this.documentEffect)||void 0===t||t.record(),ft(this.microAppWindow.microApp)}rebuildEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.rebuild(),null===(t=this.documentEffect)||void 0===t||t.rebuild(),_t(this.microAppWindow.microApp)}releaseGlobalEffect({clearData:e=!1}){var t,n,o,r,i;null===(t=this.windowEffect)||void 0===t||t.release(),null===(n=this.documentEffect)||void 0===n||n.release(),null===(o=this.microAppWindow.microApp)||void 0===o||o.clearDataListener(),null===(r=this.microAppWindow.microApp)||void 0===r||r.clearGlobalDataListener(),e&&(io.clearData(this.microAppWindow.__MICRO_APP_NAME__),null===(i=this.microAppWindow.microApp)||void 0===i||i.clearData())}setPreRenderState(e){this.microAppWindow.__MICRO_APP_PRE_RENDER__=e}markUmdMode(e){this.microAppWindow.__MICRO_APP_UMD_MODE__=e}patchIframe(e,t){const n=e.document;this.sandboxReady=new Promise((o=>{!function r(){setTimeout((()=>{try{e.document===n?r():(e.stop(),t(o))}catch(e){r()}}),0)}()}))}createIframeTemplate(e){const t=e.document;!function(e){for(;null==e?void 0:e.firstChild;)e.removeChild(e.firstChild)}(t);const n=t.createElement("html");n.innerHTML="<head></head><body></body>",t.appendChild(n),this.microBody=t.body,this.microHead=t.head}createIframeBase(){this.baseElement=X("base"),this.updateIframeBase(),this.microHead.appendChild(this.baseElement)}getSpecialProperties(e){var t;w(io.options.plugins)&&(this.commonActionForSpecialProperties(io.options.plugins.global),this.commonActionForSpecialProperties(null===(t=io.options.plugins.modules)||void 0===t?void 0:t[e]))}commonActionForSpecialProperties(e){if(i(e))for(const t of e)w(t)&&i(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties))}initRouteState(e){fn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location,e)}clearRouteState(e){An(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow.location,e)}setRouteInfoForKeepAliveApp(){_n(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location)}removeRouteInfoForKeepAliveApp(){wn(this.microAppWindow.__MICRO_APP_NAME__)}patchStaticElement(e){bn(e,this.microAppWindow.__MICRO_APP_NAME__)}actionBeforeExecScripts(e){this.patchStaticElement(e)}setStaticAppState(e){this.microAppWindow.__MICRO_APP_STATE__=e}}Dn.activeCount=0;const In=new Map;class xn{constructor({name:e,url:t,container:n,scopecss:o,useSandbox:r,inline:i,iframe:s,ssrUrl:a,isPrefetch:c,prefetchLevel:l,routerMode:u}){this.state=Pe.CREATED,this.keepAliveState=null,this.loadSourceLevel=0,this.umdHookMount=null,this.umdHookUnmount=null,this.lifeCycleState=null,this.umdMode=!1,this.sandBox=null,this.fiber=!1,In.set(e,this),this.name=e,this.url=t,this.useSandbox=r,this.scopecss=this.useSandbox&&o,this.iframe=null!=s&&s,this.inline=this.getInlineModeState(i),this.routerMode=u||Le,this.container=null!=n?n:null,this.ssrUrl=null!=a?a:"",this.isPrefetch=null!=c&&c,this.isPrerender=3===l,this.prefetchLevel=l,this.source={html:null,links:new Set,scripts:new Set},this.loadSourceCode(),this.createSandbox()}loadSourceCode(){this.setAppState(Pe.LOADING),pe.getInstance().run(this,lt)}onLoad({html:e,defaultPage:t,routerMode:n,baseroute:o,disablePatchRequest:r}){var i;if(2==++this.loadSourceLevel)if(this.source.html=e,this.isPrefetch||this.isUnmounted()){if(this.isPrerender){const e=X("div");e.setAttribute("prerender","true"),null===(i=this.sandBox)||void 0===i||i.setPreRenderState(!0),this.mount({container:e,inline:this.inline,fiber:!0,defaultPage:t||"",disablePatchRequest:null!=r&&r,routerMode:n,baseroute:o||""})}}else Y(this.container).mount(this)}onLoadError(e){this.loadSourceLevel=-1,this.isUnmounted()||(this.onerror(e),this.setAppState(Pe.LOAD_FAILED))}mount({container:e,inline:t,routerMode:n,defaultPage:o,baseroute:r,disablePatchRequest:i,fiber:s}){if(2!==this.loadSourceLevel)return this.container=e,this.isPrerender=!1,le(this,"statechange",{appState:Pe.LOADING}),this.setAppState(Pe.LOADING);this.createSandbox(),this.setAppState(Pe.BEFORE_MOUNT);const a=()=>{var a,c,l,u,d,f,_,w;if(this.isPrerender&&(w=this.container,"[object HTMLDivElement]"===p(w))&&this.container.hasAttribute("prerender"))null===(a=this.sandBox)||void 0===a||a.rebuildEffectSnapshot(),this.cloneContainer(e,this.container,!1),this.container=e,null===(c=this.preRenderEvents)||void 0===c||c.forEach((e=>e())),this.isPrerender=!1,this.preRenderEvents=null,Zt.attachToURL(this.name),null===(l=this.sandBox)||void 0===l||l.setPreRenderState(!1);else{this.container=e,this.inline=this.getInlineModeState(t),this.fiber=s,this.routerMode=n;const a=()=>{this.setLifeCycleState(Re.BEFOREMOUNT),ce(this.container,this.name,Re.BEFOREMOUNT)};if(this.isPrerender?(null!==(u=this.preRenderEvents)&&void 0!==u?u:this.preRenderEvents=[]).push(a):a(),this.setAppState(Pe.MOUNTING),le(this,"statechange",{appState:Pe.MOUNTING}),this.cloneContainer(this.container,this.source.html,!this.umdMode),null===(d=this.sandBox)||void 0===d||d.start({umdMode:this.umdMode,baseroute:r,defaultPage:o,disablePatchRequest:i}),this.umdMode){null===(_=this.sandBox)||void 0===_||_.rebuildEffectSnapshot();try{this.handleMounted(this.umdHookMount(io.getData(this.name,!0)))}catch(e){O("An error occurred in window.mount \n",this.name,e)}}else null===(f=this.sandBox)||void 0===f||f.actionBeforeExecScripts(this.container),function(e,t){const n=e.fiber?[]:null,o=Array.from(e.source.scripts),r=[],i=[];for(const s of o){const o=Ne.script.getInfo(s),a=o.appSpace[e.name];a.defer||a.async?(!o.isExternal||o.code||Qe(e,o)?r.push(o.code):r.push(ue(s,e.name)),i.push([s,o]),Qe(e,o)&&(t.moduleCount=t.moduleCount?++t.moduleCount:1)):re(n,(()=>{it(s,e,o),t(!1)}))}r.length?k(r,(e=>{const t=i[e.index][1];t.code=t.code||e.data}),(n=>{t.errorCount=t.errorCount?++t.errorCount:1,O(n,e.name)}),(()=>{i.forEach((([o,r])=>{m(r.code)&&re(n,(()=>{it(o,e,r,t),!Qe(e,r)&&t(!1)}))})),n?(n.push((()=>Promise.resolve(t(h(t.moduleCount)||t.errorCount===r.length)))),ie(n)):t(h(t.moduleCount)||t.errorCount===r.length)})):n?(n.push((()=>Promise.resolve(t(!0)))),ie(n)):t(!0)}(this,(e=>{if(!this.umdMode){const{mount:t,unmount:n}=this.getUmdLibraryHooks();if(this.umdHookUnmount=n,A(t)&&A(n)){this.umdHookMount=t,this.sandBox.markUmdMode(this.umdMode=!0);try{this.handleMounted(this.umdHookMount(io.getData(this.name,!0)))}catch(e){O("An error occurred in window.mount \n",this.name,e)}}else!0===e&&this.handleMounted()}}))}};this.sandBox?this.sandBox.sandboxReady.then(a):a()}handleMounted(e){var t,n;const o=()=>{g(e)?e.then((()=>this.dispatchMountedEvent())).catch((e=>{O("An error occurred in window.mount \n",this.name,e),this.dispatchMountedEvent()})):this.dispatchMountedEvent()};this.isPrerender?(null===(t=this.preRenderEvents)||void 0===t||t.push(o),null===(n=this.sandBox)||void 0===n||n.recordAndReleaseEffect({isPrerender:!0})):o()}dispatchMountedEvent(){var e;this.isUnmounted()||(this.setAppState(Pe.MOUNTED),ae(this.getMicroAppGlobalHook(Se.ONMOUNT),this.name,Se.ONMOUNT,io.getData(this.name,!0)),le(this,"statechange",{appState:Pe.MOUNTED}),le(this,"mounted"),this.setLifeCycleState(Re.MOUNTED),ce(this.container,this.name,Re.MOUNTED),this.isHidden()&&(null===(e=this.sandBox)||void 0===e||e.recordAndReleaseEffect({keepAlive:!0})))}unmount({destroy:e,clearData:t,keepRouteState:n,unmountcb:o}){var r;e=e||this.state===Pe.LOAD_FAILED,this.setAppState(Pe.UNMOUNT);let i=null;try{i=null===(r=this.umdHookUnmount)||void 0===r?void 0:r.call(this,io.getData(this.name,!0))}catch(e){O("An error occurred in window.unmount \n",this.name,e)}le(this,"statechange",{appState:Pe.UNMOUNT}),le(this,"unmount"),ae(this.getMicroAppGlobalHook(Se.ONUNMOUNT),this.name,Se.ONUNMOUNT),this.handleUnmounted({destroy:e,clearData:t,keepRouteState:n,unmountcb:o,umdHookUnmountResult:i})}handleUnmounted({destroy:e,clearData:t,keepRouteState:n,unmountcb:o,umdHookUnmountResult:r}){const i=()=>this.actionsForUnmount({destroy:e,clearData:t,keepRouteState:n,unmountcb:o});g(r)?(G(),r.then(i).catch(i)):i()}actionsForUnmount({destroy:e,clearData:t,keepRouteState:n,unmountcb:o}){var r;this.umdMode&&this.container&&!e&&this.cloneContainer(this.source.html,this.container,!1),null===(r=this.sandBox)||void 0===r||r.stop({umdMode:this.umdMode,keepRouteState:n&&!e,destroy:e,clearData:t||e}),this.setLifeCycleState(Re.UNMOUNT),ce(this.container,this.name,Re.UNMOUNT),this.clearOptions(e),null==o||o()}clearOptions(e){this.container.innerHTML="",this.container=null,this.isPrerender=!1,this.preRenderEvents=null,this.setKeepAliveState(null),this.iframe&&!this.umdMode&&(this.sandBox=null),e&&this.actionsForCompletelyDestroy(),G()}actionsForCompletelyDestroy(){var e,t;null===(t=null===(e=this.sandBox)||void 0===e?void 0:e.deleteIframeElement)||void 0===t||t.call(e),Ne.script.deleteInlineInfo(this.source.scripts),In.delete(this.name)}hiddenKeepAliveApp(e){var t,n;this.setKeepAliveState(Me.KEEP_ALIVE_HIDDEN),le(this,"appstate-change",{appState:"afterhidden"}),this.setLifeCycleState(Re.AFTERHIDDEN),ce(this.container,this.name,Re.AFTERHIDDEN),Bt(this.name)&&(null===(t=this.sandBox)||void 0===t||t.removeRouteInfoForKeepAliveApp()),2!==this.loadSourceLevel?Y(this.container).unmount():(this.container=this.cloneContainer(X("div"),this.container,!1),null===(n=this.sandBox)||void 0===n||n.recordAndReleaseEffect({keepAlive:!0})),null==e||e()}showKeepAliveApp(e){var t,n;null===(t=this.sandBox)||void 0===t||t.rebuildEffectSnapshot(),le(this,"appstate-change",{appState:"beforeshow"}),ce(e,this.name,Re.BEFORESHOW),this.setKeepAliveState(Me.KEEP_ALIVE_SHOW),this.container=this.cloneContainer(e,this.container,!1),Bt(this.name)&&(null===(n=this.sandBox)||void 0===n||n.setRouteInfoForKeepAliveApp()),le(this,"appstate-change",{appState:"aftershow"}),this.setLifeCycleState(Re.AFTERSHOW),ce(this.container,this.name,Re.AFTERSHOW)}onerror(e){this.setLifeCycleState(Re.ERROR),le(this,"statechange",{appState:Pe.LOAD_FAILED}),ce(this.container,this.name,Re.ERROR,e)}parseHtmlString(e){var t;return(new((null===(t=this.sandBox)||void 0===t?void 0:t.proxyWindow)?this.sandBox.proxyWindow.DOMParser:Gn.rawWindow.DOMParser)).parseFromString(e,"text/html").body}cloneContainer(e,t,n){return t&&(e.innerHTML="",Array.from(n?this.parseHtmlString(t.innerHTML).childNodes:t.childNodes).forEach((t=>{e.appendChild(t)}))),e}createSandbox(){this.useSandbox&&!this.sandBox&&(this.sandBox=this.iframe?new Dn(this.name,this.url):new Mn(this.name,this.url))}setAppState(e){var t;this.state=e,null===(t=this.sandBox)||void 0===t||t.setStaticAppState(e)}getAppState(){return this.state}setLifeCycleState(e){this.lifeCycleState=e}getLifeCycleState(){return this.lifeCycleState||""}setKeepAliveState(e){this.keepAliveState=e}getKeepAliveState(){return this.keepAliveState}isUnmounted(){return Pe.UNMOUNT===this.state}isHidden(){return Me.KEEP_ALIVE_HIDDEN===this.keepAliveState}getUmdLibraryHooks(){if(!this.isUnmounted()&&this.sandBox){const e=Y(this.container).getAttribute("library")||`micro-app-${this.name}`,t=this.sandBox.proxyWindow;return y(t[e])?t[e]:{mount:t.mount,unmount:t.unmount}}return{}}getMicroAppGlobalHook(e){var t,n;const o=null===(n=null===(t=this.sandBox)||void 0===t?void 0:t.proxyWindow)||void 0===n?void 0:n[e];return A(o)?o:null}querySelector(e){return this.container?Gn.rawElementQuerySelector.call(this.container,e):null}querySelectorAll(e){return this.container?Gn.rawElementQuerySelectorAll.call(this.container,e):[]}getInlineModeState(e){var t;return null!==(t=this.iframe||e)&&void 0!==t&&t}}function Ln(e){var t,n;return null!==(n=null===(t=In.get(e))||void 0===t?void 0:t.iframe)&&void 0!==n&&n}const Tn=new WeakMap;function Wn(e){var t;return null!==(t=Tn.get(e))&&void 0!==t?t:e}function Un(e,t){if(Tn.has(e))return Tn.get(e);if(S(e)){if(e.hasAttribute("exclude")){const t=document.createComment("style element with exclude attribute ignored by micro-app");return Tn.set(e,t),t}return t.scopecss&&!e.hasAttribute("ignore")?we(e,t):e}if(R(e)){if(e.hasAttribute("exclude")||nt(e.getAttribute("href"),t.name)){const t=document.createComment("link element with exclude attribute ignored by micro-app");return Tn.set(e,t),t}if(e.hasAttribute("ignore")||ot(e.getAttribute("href"),t.name)||e.href&&A(io.options.excludeAssetFilter)&&io.options.excludeAssetFilter(e.href))return e;const{address:n,linkInfo:o,replaceComment:r}=Oe(e,null,t,!0);if(n&&o){const r=function(e,t,n,o){const r=X("style"),i=()=>{Ie(t,e,r,n,n.appSpace[t.name].attrs),be(o)};return n.code?I(i):ue(e,t.name).then((e=>{n.code=e,i()})).catch((e=>{O(e,t.name),ve(o)})),r}(n,t,o,e);return Tn.set(e,r),r}return r?(Tn.set(e,r),r):e}if(M(e)){if(e.src&&A(io.options.excludeAssetFilter)&&io.options.excludeAssetFilter(e.src))return e;const{replaceComment:n,address:o,scriptInfo:r}=et(e,null,t,!0)||{};if(o&&r){const n=r.isExternal?function(e,t,n,o){const r=Xe(t,n)?X("script"):document.createComment("dynamic script extract by micro-app"),i=()=>be(o),s=()=>{const s=Object.getOwnPropertyDescriptor(Gn.rawDocument,"currentScript");s&&!s.configurable||Object.defineProperty(Gn.rawDocument,"currentScript",{value:o,configurable:!0}),it(e,t,n,i,r),!Qe(t,n)&&i()};return n.code||Qe(t,n)?I(s):ue(e,t.name).then((e=>{n.code=e,s()})).catch((e=>{O(e,t.name),ve(o)})),r}(o,t,r,e):function(e,t,n){const o=Xe(t,n)?X("script"):document.createComment("dynamic script extract by micro-app");return it(e,t,n,void 0,o),o}(o,t,r);return Tn.set(e,n),n}return n?(Tn.set(e,n),n):e}return e}function Bn(e,t,n,o,r){const i=kn(n,o,e);if(i){if(!Ln(e.name)&&C(i)&&t!==Gn.rawRemoveChild){const t=Object.getOwnPropertyDescriptor(o,"parentNode");t&&!t.configurable||o.__MICRO_APP_HAS_DPN__||c(o,{parentNode:{configurable:!0,get(){var t,n;const o=Gn.rawParentNodeDesc.get.call(this);return C(o)&&e.container?(null===(n=(t=io.options).getRootElementParentNode)||void 0===n?void 0:n.call(t,this,e.name))||document.body:o}},__MICRO_APP_HAS_DPN__:{configurable:!0,get:()=>!0}})}if(r&&!i.contains(r)){if(t===Gn.rawInsertBefore&&n.contains(r)){const e=Array.from(n.childNodes).indexOf(r);if(i.childNodes[e])return Hn(t,i,o,i.childNodes[e])}return Gn.rawAppendChild.call(i,o)}return t!==Gn.rawRemoveChild||i.contains(o)?Hn(t,i,o,r):n.contains(o)?t.call(n,o):o}return Hn(t,n,o,r)}function kn(e,t,n){if(n){if(e===document.head)return n.iframe&&M(t)?n.sandBox.microHead:n.querySelector("micro-app-head");if(e===document.body||e===document.body.parentNode)return n.iframe&&M(t)?n.sandBox.microBody:n.querySelector("micro-app-body");if(n.iframe&&M(t))return n.sandBox.microBody}return null}function Hn(e,t,n,o){return(r=e)===Gn.rawAppend||r===Gn.rawPrepend?e.call(t,n):e.call(t,n,o);var r}function Fn(e,t,n,o){const r=K();if(P(t)&&!t.__PURE_ELEMENT__&&(t.__MICRO_APP_NAME__||r)){t.__MICRO_APP_NAME__=t.__MICRO_APP_NAME__||r;const i=In.get(t.__MICRO_APP_NAME__);if(S(t)){e.getRootNode()instanceof ShadowRoot&&t.setAttribute("ignore","true")}if(null==i?void 0:i.container)return function(e,t){E(t)&&(/^(img|script)$/i.test(t.tagName)?(t.hasAttribute("src")&&Gn.rawSetAttribute.call(t,"src",B(t.getAttribute("src"),e.url)),t.hasAttribute("srcset")&&Gn.rawSetAttribute.call(t,"srcset",B(t.getAttribute("srcset"),e.url))):/^link$/i.test(t.tagName)&&t.hasAttribute("href")&&Gn.rawSetAttribute.call(t,"href",B(t.getAttribute("href"),e.url)))}(i,t),Bn(i,o,e,Un(t,i),n&&Wn(n))}return o===Gn.rawAppend||o===Gn.rawPrepend?o.call(e,t):o.call(e,t,n)}function $n(){!function(){const e=Gn.rawDocument,t=Gn.rawRootDocument;function n(t){return function(e){return"[object ProxyDocument]"===p(e)}(t)?e:t}function o(t){var o,r;const i=n(this),s=K();return s&&t&&!V(t)&&e===i?null!==(r=null===(o=In.get(s))||void 0===o?void 0:o.querySelector(t))&&void 0!==r?r:null:Gn.rawQuerySelector.call(i,t)}function r(t){var o,r;const i=n(this),s=K();return s&&t&&!V(t)&&e===i?null!==(r=null===(o=In.get(s))||void 0===o?void 0:o.querySelectorAll(t))&&void 0!==r?r:[]:Gn.rawQuerySelectorAll.call(i,t)}t.prototype.createElement=function(e,t){return jn(Gn.rawCreateElement.call(n(this),e,t))},t.prototype.createElementNS=function(e,t,o){return jn(Gn.rawCreateElementNS.call(n(this),e,t,o))},t.prototype.createDocumentFragment=function(){return jn(Gn.rawCreateDocumentFragment.call(n(this)))},t.prototype.createComment=function(e){return jn(Gn.rawCreateComment.call(n(this),e))},t.prototype.querySelector=o,t.prototype.querySelectorAll=r,t.prototype.getElementById=function(e){const t=n(this);if(!K()||z(e))return Gn.rawGetElementById.call(t,e);try{return o.call(t,`#${e}`)}catch(n){return Gn.rawGetElementById.call(t,e)}},t.prototype.getElementsByClassName=function(e){const t=n(this);if(!K()||z(e))return Gn.rawGetElementsByClassName.call(t,e);try{return r.call(t,`.${e}`)}catch(n){return Gn.rawGetElementsByClassName.call(t,e)}},t.prototype.getElementsByTagName=function(e){var t;const o=n(this),i=K();if(!i||V(e)||z(e)||!(null===(t=In.get(i))||void 0===t?void 0:t.inline)&&/^script$/i.test(e))return Gn.rawGetElementsByTagName.call(o,e);try{return r.call(o,e)}catch(t){return Gn.rawGetElementsByTagName.call(o,e)}},t.prototype.getElementsByName=function(e){const t=n(this);if(!K()||z(e))return Gn.rawGetElementsByName.call(t,e);try{return r.call(t,`[name=${e}]`)}catch(n){return Gn.rawGetElementsByName.call(t,e)}}}();const e=Gn.rawRootElement,t=Gn.rawRootNode;function n(e){const t=K();if((e===document.body||e===document.head)&&t){const n=In.get(t);if(null==n?void 0:n.container){if(e===document.body)return n.querySelector("micro-app-body");if(e===document.head)return n.querySelector("micro-app-head")}}return e}e.prototype.appendChild=function(e){return Fn(this,e,null,Gn.rawAppendChild)},e.prototype.insertBefore=function(e,t){return Fn(this,e,t,Gn.rawInsertBefore)},e.prototype.replaceChild=function(e,t){return Fn(this,e,t,Gn.rawReplaceChild)},e.prototype.append=function(...e){let t=0;for(;t<e.length;){let n=e[t];n=P(n)?n:Gn.rawCreateTextNode.call(Gn.rawDocument,n),Fn(this,jn(n),null,Gn.rawAppend),t++}},e.prototype.prepend=function(...e){let t=e.length;for(;t>0;){let n=e[t-1];n=P(n)?n:Gn.rawCreateTextNode.call(Gn.rawDocument,n),Fn(this,jn(n),null,Gn.rawPrepend),t--}},e.prototype.removeChild=function(e){if(null==e?void 0:e.__MICRO_APP_NAME__){const t=In.get(e.__MICRO_APP_NAME__);if(null==t?void 0:t.container)return Bn(t,Gn.rawRemoveChild,this,Wn(e));try{return Gn.rawRemoveChild.call(this,e)}catch(t){return(null==e?void 0:e.parentNode)&&Gn.rawRemoveChild.call(e.parentNode,e)}}return Gn.rawRemoveChild.call(this,e)},e.prototype.insertAdjacentElement=function(e,t){var n;if((null==t?void 0:t.__MICRO_APP_NAME__)&&E(t)){const o=In.get(t.__MICRO_APP_NAME__);if(null==o?void 0:o.container){const r=Un(t,o);if(!E(r))return t;const i=null!==(n=kn(this,r,o))&&void 0!==n?n:this;return Gn.rawInsertAdjacentElement.call(i,e,r)}}return Gn.rawInsertAdjacentElement.call(this,e,t)},e.prototype.cloneNode=function(e){const t=Gn.rawCloneNode.call(this,e);return this.__MICRO_APP_NAME__&&(t.__MICRO_APP_NAME__=this.__MICRO_APP_NAME__),t},e.prototype.querySelector=function(e){var t;return Gn.rawElementQuerySelector.call(null!==(t=n(this))&&void 0!==t?t:this,e)},e.prototype.querySelectorAll=function(e){var t;return Gn.rawElementQuerySelectorAll.call(null!==(t=n(this))&&void 0!==t?t:this,e)},e.prototype.setAttribute=function(e,t){const n=this.__MICRO_APP_NAME__||K();if(n&&In.has(n)&&(("src"===e||"srcset"===e)&&/^(img|script|video|audio|source|embed)$/i.test(this.tagName)||"href"===e&&/^link$/i.test(this.tagName))){t=B(t,In.get(n).url)}Gn.rawSetAttribute.call(this,e,t)},a(e.prototype,"innerHTML",{configurable:!0,enumerable:!0,get(){return Gn.rawInnerHTMLDesc.get.call(this)},set(e){Gn.rawInnerHTMLDesc.set.call(this,e);const t=K();Array.from(this.children).forEach((e=>{E(e)&&t&&(e.__MICRO_APP_NAME__=t)}))}}),a(t.prototype,"parentNode",{configurable:!0,enumerable:!0,get(){var e,t,n;const o=K();if(o&&this===Gn.rawDocument.firstElementChild){const r=null===(n=null===(t=null===(e=In.get(o))||void 0===e?void 0:e.sandBox)||void 0===t?void 0:t.proxyWindow)||void 0===n?void 0:n.document;if(r)return r}return Gn.rawParentNodeDesc.get.call(this)}})}function jn(e){const t=K();return t&&(e.__MICRO_APP_NAME__=t),e}function Kn(){G(),function(){const e=Gn.rawRootDocument;e.prototype.createElement=Gn.rawCreateElement,e.prototype.createElementNS=Gn.rawCreateElementNS,e.prototype.createDocumentFragment=Gn.rawCreateDocumentFragment,e.prototype.querySelector=Gn.rawQuerySelector,e.prototype.querySelectorAll=Gn.rawQuerySelectorAll,e.prototype.getElementById=Gn.rawGetElementById,e.prototype.getElementsByClassName=Gn.rawGetElementsByClassName,e.prototype.getElementsByTagName=Gn.rawGetElementsByTagName,e.prototype.getElementsByName=Gn.rawGetElementsByName}();const e=Gn.rawRootElement,t=Gn.rawRootNode;e.prototype.appendChild=Gn.rawAppendChild,e.prototype.insertBefore=Gn.rawInsertBefore,e.prototype.replaceChild=Gn.rawReplaceChild,e.prototype.removeChild=Gn.rawRemoveChild,e.prototype.append=Gn.rawAppend,e.prototype.prepend=Gn.rawPrepend,e.prototype.cloneNode=Gn.rawCloneNode,e.prototype.querySelector=Gn.rawElementQuerySelector,e.prototype.querySelectorAll=Gn.rawElementQuerySelectorAll,e.prototype.setAttribute=Gn.rawSetAttribute,a(e.prototype,"innerHTML",Gn.rawInnerHTMLDesc),a(t.prototype,"parentNode",Gn.rawParentNodeDesc)}let qn=!1;const Gn={activeSandbox:0};function Qn(){if(n){const e=window.rawWindow||Function("return window")(),t=window.rawDocument||Function("return document")(),n=e.Document||Function("return Document")(),o=e.Element,r=e.Node,i=e.EventTarget,a=o.prototype.setAttribute,c=o.prototype.appendChild,l=o.prototype.insertBefore,u=o.prototype.replaceChild,p=o.prototype.removeChild,h=o.prototype.append,d=o.prototype.prepend,m=o.prototype.cloneNode,f=o.prototype.querySelector,_=o.prototype.querySelectorAll,A=o.prototype.insertAdjacentElement,w=Object.getOwnPropertyDescriptor(o.prototype,"innerHTML"),y=Object.getOwnPropertyDescriptor(r.prototype,"parentNode"),g=n.prototype.createElement,b=n.prototype.createElementNS,v=n.prototype.createTextNode,E=n.prototype.createDocumentFragment,P=n.prototype.createComment,R=n.prototype.querySelector,S=n.prototype.querySelectorAll,M=n.prototype.getElementById,C=n.prototype.getElementsByClassName,N=n.prototype.getElementsByTagName,O=n.prototype.getElementsByName,D=new Proxy(Image,{construct(e,t){const n=new e(...t),o=K();return o&&(n.__MICRO_APP_NAME__=o),n}}),I=e.setInterval,x=e.setTimeout,L=e.clearInterval,T=e.clearTimeout,W=e.history.pushState,U=e.history.replaceState,B=i.prototype.addEventListener,k=i.prototype.removeEventListener,H=i.prototype.dispatchEvent;window.__MICRO_APP_BASE_APPLICATION__=!0,s(Gn,{supportModuleScript:"noModule"in document.createElement("script"),rawWindow:e,rawDocument:t,rawRootDocument:n,rawRootElement:o,rawRootNode:r,rawSetAttribute:a,rawAppendChild:c,rawInsertBefore:l,rawReplaceChild:u,rawRemoveChild:p,rawAppend:h,rawPrepend:d,rawCloneNode:m,rawElementQuerySelector:f,rawElementQuerySelectorAll:_,rawInsertAdjacentElement:A,rawInnerHTMLDesc:w,rawParentNodeDesc:y,rawCreateElement:g,rawCreateElementNS:b,rawCreateDocumentFragment:E,rawCreateTextNode:v,rawCreateComment:P,rawQuerySelector:R,rawQuerySelectorAll:S,rawGetElementById:M,rawGetElementsByClassName:C,rawGetElementsByTagName:N,rawGetElementsByName:O,ImageProxy:D,rawSetInterval:I,rawSetTimeout:x,rawClearInterval:L,rawClearTimeout:T,rawPushState:W,rawReplaceState:U,rawAddEventListener:B,rawRemoveEventListener:k,rawDispatchEvent:H}),function(){if(!qn){qn=!0;const e=X("style");Gn.rawSetAttribute.call(e,"type","text/css"),e.textContent=`\n${io.tagName}, micro-app-body { display: block; } \nmicro-app-head { display: none; }`,Gn.rawDocument.head.appendChild(e)}}()}}function Xn(e){class n extends(function(){var e;return(null===(e=window.rawWindow)||void 0===e?void 0:e.HTMLElement)||window.HTMLElement}()){constructor(){super(...arguments),this.isWaiting=!1,this.cacheData=null,this.connectedCount=0,this.connectStateMap=new Map,this.appName="",this.appUrl="",this.ssrUrl="",this.version=t,this.handleAttributeUpdate=()=>{this.isWaiting=!1;const e=W(this.getAttribute("name")),t=T(this.getAttribute("url"),this.appName);if(this.legalAttribute("name",e)&&this.legalAttribute("url",t)){const n=In.get(e);if(e!==this.appName&&n&&!n.isUnmounted()&&!n.isHidden()&&!n.isPrefetch)return this.setAttribute("name",this.appName),O(`app name conflict, an app named ${e} is running`);e===this.appName&&t===this.appUrl||(e===this.appName?this.unmount(!0,(()=>{this.actionsForAttributeChange(e,t,n)})):this.getKeepAliveModeResult()?(this.handleHiddenKeepAliveApp(),this.actionsForAttributeChange(e,t,n)):this.unmount(!1,(()=>{this.actionsForAttributeChange(e,t,n)})))}else e!==this.appName&&this.setAttribute("name",this.appName)}}static get observedAttributes(){return["name","url"]}connectedCallback(){const e=++this.connectedCount;this.connectStateMap.set(e,!0);const t=this.appName&&this.appUrl;I((()=>{this.connectStateMap.get(e)&&(ce(this,this.appName,Re.CREATED),t&&this.handleConnected())}))}disconnectedCallback(){this.connectStateMap.set(this.connectedCount,!1),this.handleDisconnected()}reload(e){return new Promise((t=>{const n=()=>{this.removeEventListener(Re.MOUNTED,n),this.removeEventListener(Re.AFTERSHOW,n),t(!0)};this.addEventListener(Re.MOUNTED,n),this.addEventListener(Re.AFTERSHOW,n),this.handleDisconnected(e,(()=>{this.handleConnected()}))}))}handleDisconnected(e=!1,t){const n=In.get(this.appName);!n||n.isUnmounted()||n.isHidden()||(this.getKeepAliveModeResult()&&!e?this.handleHiddenKeepAliveApp(t):this.unmount(e,t))}attributeChangedCallback(e,t,n){if(this.legalAttribute(e,n)&&this[e===Ee.NAME?"appName":"appUrl"]!==n)if(e!==Ee.URL||this.appUrl&&this.connectStateMap.get(this.connectedCount))if(e!==Ee.NAME||this.appName&&this.connectStateMap.get(this.connectedCount))this.isWaiting||(this.isWaiting=!0,I(this.handleAttributeUpdate));else{const e=W(n);if(!e)return O(`Invalid attribute name ${n}`,this.appName);this.cacheData&&(io.setData(e,this.cacheData),this.cacheData=null),this.appName=e,e!==n&&this.setAttribute("name",this.appName),this.handleInitialNameAndUrl()}else{if(!(n=T(n,this.appName)))return O(`Invalid attribute url ${n}`,this.appName);this.appUrl=n,this.handleInitialNameAndUrl()}}handleInitialNameAndUrl(){this.connectStateMap.get(this.connectedCount)&&this.handleConnected()}handleConnected(){if(this.appName&&this.appUrl)if(this.getDisposeResult("shadowDOM")&&!this.shadowRoot&&A(this.attachShadow)&&this.attachShadow({mode:"open"}),this.updateSsrUrl(this.appUrl),In.has(this.appName)){const e=In.get(this.appName),t=e.ssrUrl||e.url,n=this.ssrUrl||this.appUrl;e.isHidden()&&e.url===this.appUrl?this.handleShowKeepAliveApp(e):t===n&&(e.isUnmounted()||e.isPrefetch&&this.sameCoreOptions(e))?this.handleMount(e):e.isPrefetch||e.isUnmounted()?this.handleCreateApp():O(`app name conflict, an app named: ${this.appName} with url: ${t} is running`)}else this.handleCreateApp()}actionsForAttributeChange(e,t,n){var o;this.updateSsrUrl(t),this.appName=e,this.appUrl=t,(null!==(o=this.shadowRoot)&&void 0!==o?o:this).innerHTML="",e!==this.getAttribute("name")&&this.setAttribute("name",this.appName),n?n.isHidden()?n.url===this.appUrl?this.handleShowKeepAliveApp(n):O(`app name conflict, an app named ${this.appName} is running`):n.url===this.appUrl&&n.ssrUrl===this.ssrUrl?this.handleMount(n):this.handleCreateApp():this.handleCreateApp()}legalAttribute(e,t){return!(!m(t)||!t)||(O(`unexpected attribute ${e}, please check again`,this.appName),!1)}handleCreateApp(){const e=()=>{var e;return new xn({name:this.appName,url:this.appUrl,container:null!==(e=this.shadowRoot)&&void 0!==e?e:this,scopecss:this.useScopecss(),useSandbox:this.useSandbox(),inline:this.getDisposeResult("inline"),iframe:this.getDisposeResult("iframe"),ssrUrl:this.ssrUrl,routerMode:this.getMemoryRouterMode()})},t=In.get(this.appName);t?t.isPrerender?this.unmount(!0,e):(t.actionsForCompletelyDestroy(),e()):e()}handleMount(e){e.isPrefetch=!1,e.setAppState(Pe.BEFORE_MOUNT),I((()=>this.mount(e)))}mount(e){var t;e.mount({container:null!==(t=this.shadowRoot)&&void 0!==t?t:this,inline:this.getDisposeResult("inline"),routerMode:this.getMemoryRouterMode(),baseroute:this.getBaseRouteCompatible(),defaultPage:this.getDefaultPage(),disablePatchRequest:this.getDisposeResult("disable-patch-request"),fiber:this.getDisposeResult("fiber")})}unmount(e,t){const n=In.get(this.appName);n&&!n.isUnmounted()&&n.unmount({destroy:e||this.getDestroyCompatibleResult(),clearData:this.getDisposeResult("clear-data"),keepRouteState:this.getDisposeResult("keep-router-state"),unmountcb:t})}handleHiddenKeepAliveApp(e){const t=In.get(this.appName);!t||t.isUnmounted()||t.isHidden()||t.hiddenKeepAliveApp(e)}handleShowKeepAliveApp(e){I((()=>{var t;return e.showKeepAliveApp(null!==(t=this.shadowRoot)&&void 0!==t?t:this)}))}getDisposeResult(e){return(this.compatibleProperties(e)||!!io.options[e])&&this.compatibleDisableProperties(e)}compatibleProperties(e){return"disable-scopecss"===e?this.hasAttribute("disable-scopecss")||this.hasAttribute("disableScopecss"):"disable-sandbox"===e?this.hasAttribute("disable-sandbox")||this.hasAttribute("disableSandbox"):this.hasAttribute(e)}compatibleDisableProperties(e){return"disable-scopecss"===e?"false"!==this.getAttribute("disable-scopecss")&&"false"!==this.getAttribute("disableScopecss"):"disable-sandbox"===e?"false"!==this.getAttribute("disable-sandbox")&&"false"!==this.getAttribute("disableSandbox"):"false"!==this.getAttribute(e)}useScopecss(){return!(this.getDisposeResult("disable-scopecss")||this.getDisposeResult("shadowDOM"))}useSandbox(){return!this.getDisposeResult("disable-sandbox")}sameCoreOptions(e){return e.scopecss===this.useScopecss()&&e.useSandbox===this.useSandbox()&&e.iframe===this.getDisposeResult("iframe")}getBaseRouteCompatible(){var e,t;return null!==(t=null!==(e=this.getAttribute("baseroute"))&&void 0!==e?e:this.getAttribute("baseurl"))&&void 0!==t?t:""}getDestroyCompatibleResult(){return this.getDisposeResult("destroy")||this.getDisposeResult("destory")}getKeepAliveModeResult(){return this.getDisposeResult("keep-alive")&&!this.getDestroyCompatibleResult()}updateSsrUrl(e){if(this.getDisposeResult("ssr"))if(this.getDisposeResult("disable-memory-router")||this.getDisposeResult("disableSandbox")){const t=Gn.rawWindow.location;this.ssrUrl=B(t.pathname+t.search,e)}else{let t=function(e,t){const n=Lt(e);if(!n)return"";const o=x(n,t);return o.origin+o.pathname+o.search}(this.appName,e);const n=this.getDefaultPage();if(!t&&n){const o=x(n,e);t=o.origin+o.pathname+o.search}this.ssrUrl=t}else this.ssrUrl&&(this.ssrUrl="")}getDefaultPage(){return Zt.getDefaultPage(this.appName)||this.getAttribute("default-page")||this.getAttribute("defaultPage")||""}getMemoryRouterMode(){return $t(this.getAttribute("router-mode"),this.compatibleProperties("disable-memory-router")&&this.compatibleDisableProperties("disable-memory-router"))}setAttribute(e,t){if("data"===e)if(w(t)){const e={};Object.getOwnPropertyNames(t).forEach((n=>{m(n)&&0===n.indexOf("__")||(e[n]=t[n])})),this.data=e}else"[object Object]"!==t&&D("property data must be an object",this.appName);else Gn.rawSetAttribute.call(this,e,t)}set data(e){this.appName?io.setData(this.appName,e):this.cacheData=e}get data(){return this.appName?io.getData(this.appName,!0):this.cacheData?this.cacheData:null}get publicPath(){return U(this.appUrl)}get baseRoute(){return this.getBaseRouteCompatible()}}Gn.rawWindow.customElements.define(e,n)}function zn(e,t){if(!n)return O("preFetch is only supported in browser environment");H((()=>{const n=_(t)?t:io.options.prefetchDelay;setTimeout((()=>{!function(e){A(e)&&(e=e()),i(e)&&e.reduce(((e,t)=>e.then((()=>{return e=t,F((t=>{var n,o,r,i,a,c;if(w(e)&&navigator.onLine)if(e.name=W(e.name),e.url=T(e.url,e.name),e.name&&e.url&&!In.has(e.name)){const l=new xn({name:e.name,url:e.url,isPrefetch:!0,scopecss:!(null!==(o=null!==(n=e["disable-scopecss"])&&void 0!==n?n:e.disableScopecss)&&void 0!==o?o:io.options["disable-scopecss"]),useSandbox:!(null!==(i=null!==(r=e["disable-sandbox"])&&void 0!==r?r:e.disableSandbox)&&void 0!==i?i:io.options["disable-sandbox"]),inline:null!==(a=e.inline)&&void 0!==a?a:io.options.inline,iframe:null!==(c=e.iframe)&&void 0!==c?c:io.options.iframe,prefetchLevel:e.level&&xe.includes(e.level)?e.level:io.options.prefetchLevel&&xe.includes(io.options.prefetchLevel)?io.options.prefetchLevel:2}),u=l.onLoad,p=l.onLoadError;l.onLoad=n=>{l.isPrerender&&s(n,{defaultPage:e["default-page"],routerMode:$t(e["router-mode"]),baseroute:e.baseroute,disablePatchRequest:e["disable-patch-request"]}),t(),u.call(l,n)},l.onLoadError=(...e)=>{t(),p.call(l,...e)}}else t();else t()}));var e}))),Promise.resolve())}(e)}),_(n)?n:3e3)}))}function Vn(e,t,n){if(i(e)){const o=e.filter((e=>m(e)&&e.includes(`.${t}`)&&!n.hasInfo(e)));k(o.map((e=>ue(e))),(e=>{const r=o[e.index];"js"===t?n.hasInfo(r)||n.setInfo(r,{code:e.data,isExternal:!1,appSpace:{}}):n.hasInfo(r)||n.setInfo(r,{code:e.data,appSpace:{}})}),(e=>{O(e)}))}}function Yn({excludeHiddenApp:e=!1,excludePreRender:t=!1}={}){const n=[];return In.forEach(((o,r)=>{o.isUnmounted()||o.isPrefetch&&(!o.isPrerender||t)||e&&o.isHidden()||n.push(r)})),n}function Jn(){return Array.from(In.keys())}function Zn(e,t){const n=In.get(W(e));return new Promise((o=>{if(n)if(n.isUnmounted()||n.isPrefetch)n.isPrerender?n.unmount({destroy:!!(null==t?void 0:t.destroy),clearData:!!(null==t?void 0:t.clearData),keepRouteState:!1,unmountcb:o.bind(null,!0)}):((null==t?void 0:t.destroy)&&n.actionsForCompletelyDestroy(),o(!0));else if(n.isHidden())(null==t?void 0:t.destroy)?n.unmount({destroy:!0,clearData:!0,keepRouteState:!0,unmountcb:o.bind(null,!0)}):(null==t?void 0:t.clearAliveState)?n.unmount({destroy:!1,clearData:!!t.clearData,keepRouteState:!0,unmountcb:o.bind(null,!0)}):o(!0);else{const e=Y(n.container),r=()=>{e.removeEventListener(Re.UNMOUNT,r),e.removeEventListener(Re.AFTERHIDDEN,i),o(!0)},i=()=>{e.removeEventListener(Re.UNMOUNT,r),e.removeEventListener(Re.AFTERHIDDEN,i),o(!0)};if(e.addEventListener(Re.UNMOUNT,r),e.addEventListener(Re.AFTERHIDDEN,i),null==t?void 0:t.destroy){let t,n;e.hasAttribute("destroy")&&(t=e.getAttribute("destroy")),e.hasAttribute("destory")&&(n=e.getAttribute("destory")),e.setAttribute("destroy","true"),e.parentNode.removeChild(e),e.removeAttribute("destroy"),m(t)&&e.setAttribute("destroy",t),m(n)&&e.setAttribute("destory",n)}else if((null==t?void 0:t.clearAliveState)&&e.hasAttribute("keep-alive")){const n=e.getAttribute("keep-alive");e.removeAttribute("keep-alive");let o=null;t.clearData&&(o=e.getAttribute("clear-data"),e.setAttribute("clear-data","true")),e.parentNode.removeChild(e),e.setAttribute("keep-alive",n),m(o)&&e.setAttribute("clear-data",o)}else{let n=null;(null==t?void 0:t.clearData)&&(n=e.getAttribute("clear-data"),e.setAttribute("clear-data","true")),e.parentNode.removeChild(e),m(n)&&e.setAttribute("clear-data",n)}}else D(`app ${e} does not exist`),o(!1)}))}function eo(e){return Array.from(In.keys()).reduce(((t,n)=>t.then((()=>Zn(n,e)))),Promise.resolve(!0))}function to(e,t){return new Promise((n=>{const o=In.get(W(e));if(o){const r=o.container&&Y(o.container);r?n(r.reload(t)):(D(`app ${e} is not rendered, cannot use reload`),n(!1))}else D(`app ${e} does not exist`),n(!1)}))}function no(e){return new Promise((t=>{if(!w(e))return O("renderApp options must be an object");const n=E(e.container)?e.container:m(e.container)?document.querySelector(e.container):null;if(!E(n))return O("Target container is not a DOM element.");const o=X(io.tagName);for(const t in e)if("onDataChange"===t)A(e[t])&&o.addEventListener("datachange",e[t]);else if("lifeCycles"===t){const n=e[t];if(w(n))for(const e in n)e.toUpperCase()in Re&&A(n[e])&&o.addEventListener(e.toLowerCase(),n[e])}else"container"!==t&&o.setAttribute(t,e[t]);const r=()=>{s(),t(!0)},i=()=>{s(),t(!1)},s=()=>{o.removeEventListener(Re.MOUNTED,r),o.removeEventListener(Re.ERROR,i)};o.addEventListener(Re.MOUNTED,r),o.addEventListener(Re.ERROR,i),n.appendChild(o)}))}function oo(e){const t=In.get(W(e));if(t)return t.getLifeCycleState();D(`app ${e} does not exist`)}class ro extends dt{constructor(){super(...arguments),this.tagName="micro-app",this.hasInit=!1,this.options={},this.router=Zt,this.preFetch=zn,this.unmountApp=Zn,this.unmountAllApps=eo,this.getActiveApps=Yn,this.getAllApps=Jn,this.reload=to,this.renderApp=no,this.getAppStatus=oo}start(e){var t,o,r;if(!n||!window.customElements)return O("micro-app is not supported in this environment");if(this.hasInit)return O("microApp.start executed repeatedly");if(this.hasInit=!0,null==e?void 0:e.tagName){if(!/^micro-app(-\S+)?/.test(e.tagName))return O(`${e.tagName} is invalid tagName`);this.tagName=e.tagName}if(Qn(),Gn.rawWindow.customElements.get(this.tagName))return D(`element ${this.tagName} is already defined`);if(w(e)&&(this.options=e,e["disable-scopecss"]=null!==(t=e["disable-scopecss"])&&void 0!==t?t:e.disableScopecss,e["disable-sandbox"]=null!==(o=e["disable-sandbox"])&&void 0!==o?o:e.disableSandbox,e.preFetchApps&&zn(e.preFetchApps),e.globalAssets&&(w(r=e.globalAssets)&&H((()=>{Vn(r.js,"js",Ne.script),Vn(r.css,"css",Ne.link)}))),w(e.plugins))){const t=e.plugins.modules;if(w(t))for(const e in t){const n=W(e);n&&e!==n&&(t[n]=t[e],delete t[e])}}Xn(this.tagName)}}const io=new ro;e.EventCenterForMicroApp=mt,e.MicroApp=ro,e.default=io,e.getActiveApps=Yn,e.getAllApps=Jn,e.getAppStatus=oo,e.preFetch=zn,e.pureCreateElement=X,e.reload=to,e.removeDomScope=G,e.renderApp=no,e.unmountAllApps=eo,e.unmountApp=Zn,e.version=t,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
